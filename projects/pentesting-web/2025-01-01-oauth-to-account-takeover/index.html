<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> OAuth to Account takeover | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/projects/pentesting-web/2025-01-01-oauth-to-account-takeover/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item "> <a class="nav-link" href="/hacking/">hacking </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">OAuth to Account takeover</h1> <p class="post-description"></p> </header> <article> <h1 id="oauth-to-account-takeover">OAuth to Account takeover</h1> <h2 id="basic-information-">Basic Information <a href="#d4a8" id="d4a8"></a> </h2> <p>OAuth offers various versions, with foundational insights accessible at <a href="https://oauth.net/2/" rel="external nofollow noopener" target="_blank">OAuth 2.0 documentation</a>. This discussion primarily centers on the widely used <a href="https://oauth.net/2/grant-types/authorization-code/" rel="external nofollow noopener" target="_blank">OAuth 2.0 authorization code grant type</a>, providing an <strong>authorization framework that enables an application to access or perform actions on a user’s account in another application</strong> (the authorization server).</p> <p>Consider a hypothetical website <em><strong>https://example.com</strong></em>, designed to <strong>showcase all your social media posts</strong>, including private ones. To achieve this, OAuth 2.0 is employed. <em>https://example.com</em> will request your permission to <strong>access your social media posts</strong>. Consequently, a consent screen will appear on <em>https://socialmedia.com</em>, outlining the <strong>permissions being requested and the developer making the request</strong>. Upon your authorization, <em>https://example.com</em> gains the ability to <strong>access your posts on your behalf</strong>.</p> <p>It’s essential to grasp the following components within the OAuth 2.0 framework:</p> <ul> <li> <strong>resource owner</strong>: You, as the <strong>user/entity</strong>, authorize access to your resource, like your social media account posts.</li> <li> <strong>resource server</strong>: The <strong>server managing authenticated requests</strong> after the application has secured an <code class="language-plaintext highlighter-rouge">access token</code> on behalf of the <code class="language-plaintext highlighter-rouge">resource owner</code>, e.g., <strong>https://socialmedia.com</strong>.</li> <li> <strong>client application</strong>: The <strong>application seeking authorization</strong> from the <code class="language-plaintext highlighter-rouge">resource owner</code>, such as <strong>https://example.com</strong>.</li> <li> <strong>authorization server</strong>: The <strong>server that issues <code class="language-plaintext highlighter-rouge">access tokens</code></strong> to the <code class="language-plaintext highlighter-rouge">client application</code> following the successful authentication of the <code class="language-plaintext highlighter-rouge">resource owner</code> and securing authorization, e.g., <strong>https://socialmedia.com</strong>.</li> <li> <strong>client_id</strong>: A public, unique identifier for the application.</li> <li> <strong>client_secret:</strong> A confidential key, known solely to the application and the authorization server, used for generating <code class="language-plaintext highlighter-rouge">access_tokens</code>.</li> <li> <strong>response_type</strong>: A value specifying <strong>the type of token requested</strong>, like <code class="language-plaintext highlighter-rouge">code</code>.</li> <li> <strong>scope</strong>: The <strong>level of access</strong> the <code class="language-plaintext highlighter-rouge">client application</code> is requesting from the <code class="language-plaintext highlighter-rouge">resource owner</code>.</li> <li> <strong>redirect_uri</strong>: The <strong>URL to which the user is redirected after authorization</strong>. This typically must align with the pre-registered redirect URL.</li> <li> <strong>state</strong>: A parameter to <strong>maintain data across the user’s redirection to and from the authorization server</strong>. Its uniqueness is critical for serving as a <strong>CSRF protection mechanism</strong>.</li> <li> <strong>grant_type</strong>: A parameter indicating <strong>the grant type and the type of token to be returned</strong>.</li> <li> <strong>code</strong>: The authorization code from the <code class="language-plaintext highlighter-rouge">authorization server</code>, used in tandem with <code class="language-plaintext highlighter-rouge">client_id</code> and <code class="language-plaintext highlighter-rouge">client_secret</code> by the client application to acquire an <code class="language-plaintext highlighter-rouge">access_token</code>.</li> <li> <strong>access_token</strong>: The <strong>token that the client application uses for API requests</strong> on behalf of the <code class="language-plaintext highlighter-rouge">resource owner</code>.</li> <li> <strong>refresh_token</strong>: Enables the application to <strong>obtain a new <code class="language-plaintext highlighter-rouge">access_token</code> without re-prompting the user</strong>.</li> </ul> <h3 id="flow">Flow</h3> <p>The <strong>actual OAuth flow</strong> proceeds as follows:</p> <ol> <li>You navigate to <a href="https://example.com" rel="external nofollow noopener" target="_blank">https://example.com</a> and select the “Integrate with Social Media” button.</li> <li>The site then sends a request to <a href="https://socialmedia.com" rel="external nofollow noopener" target="_blank">https://socialmedia.com</a> asking for your authorization to let https://example.com’s application access your posts. The request is structured as:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://socialmedia.com/auth
?response_type=code
&amp;client_id=example_clientId
&amp;redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&amp;scope=readPosts
&amp;state=randomString123
</code></pre></div></div> <ol> <li>You are then presented with a consent page.</li> <li>Following your approval, Social Media sends a response to the <code class="language-plaintext highlighter-rouge">redirect_uri</code> with the <code class="language-plaintext highlighter-rouge">code</code> and <code class="language-plaintext highlighter-rouge">state</code> parameters:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://example.com?code=uniqueCode123&amp;state=randomString123
</code></pre></div></div> <ol> <li>https://example.com utilizes this <code class="language-plaintext highlighter-rouge">code</code>, together with its <code class="language-plaintext highlighter-rouge">client_id</code> and <code class="language-plaintext highlighter-rouge">client_secret</code>, to make a server-side request to obtain an <code class="language-plaintext highlighter-rouge">access_token</code> on your behalf, enabling access to the permissions you consented to:</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
</code></pre></div></div> <ol> <li>Finally, the process concludes as https://example.com employs your <code class="language-plaintext highlighter-rouge">access_token</code> to make an API call to Social Media to access</li> </ol> <h2 id="vulnerabilities-">Vulnerabilities <a href="#id-323a" id="id-323a"></a> </h2> <h3 id="open-redirect_uri-">Open redirect_uri <a href="#cc36" id="cc36"></a> </h3> <p>The <code class="language-plaintext highlighter-rouge">redirect_uri</code> is crucial for security in OAuth and OpenID implementations, as it directs where sensitive data, like authorization codes, are sent post-authorization. If misconfigured, it could allow attackers to redirect these requests to malicious servers, enabling account takeover.</p> <p>Exploitation techniques vary based on the authorization server’s validation logic. They can range from strict path matching to accepting any URL within the specified domain or subdirectory. Common exploitation methods include open redirects, path traversal, exploiting weak regexes, and HTML injection for token theft.</p> <p>Besides <code class="language-plaintext highlighter-rouge">redirect_uri</code>, other OAuth and OpenID parameters like <code class="language-plaintext highlighter-rouge">client_uri</code>, <code class="language-plaintext highlighter-rouge">policy_uri</code>, <code class="language-plaintext highlighter-rouge">tos_uri</code>, and <code class="language-plaintext highlighter-rouge">initiate_login_uri</code> are also susceptible to redirection attacks. These parameters are optional and their support varies across servers.</p> <p>For those targeting an OpenID server, the discovery endpoint (<code class="language-plaintext highlighter-rouge">**.well-known/openid-configuration**</code>) often lists valuable configuration details like <code class="language-plaintext highlighter-rouge">registration_endpoint</code>, <code class="language-plaintext highlighter-rouge">request_uri_parameter_supported</code>, and “<code class="language-plaintext highlighter-rouge">require_request_uri_registration</code>. These details can aid in identifying the registration endpoint and other configuration specifics of the server.</p> <h3 id="xss-in-redirect-implementation-">XSS in redirect implementation <a href="#bda5" id="bda5"></a> </h3> <p>As mentioned in this bug bounty report <a href="https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html" rel="external nofollow noopener" target="_blank">https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html</a> it might be possible that the redirect <strong>URL is being reflected in the response</strong> of the server after the user authenticates, being <strong>vulnerable to XSS</strong>. Possible payload to test:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard&lt;/script&gt;&lt;h1&gt;test&lt;/h1&gt;
</code></pre></div></div> <h3 id="csrf---improper-handling-of-state-parameter-">CSRF - Improper handling of state parameter <a href="#bda5" id="bda5"></a> </h3> <p>In OAuth implementations, the misuse or omission of the <strong><code class="language-plaintext highlighter-rouge">state</code> parameter</strong> can significantly increase the risk of <strong>Cross-Site Request Forgery (CSRF)</strong> attacks. This vulnerability arises when the <code class="language-plaintext highlighter-rouge">state</code> parameter is either <strong>not used, used as a static value, or not properly validated</strong>, allowing attackers to bypass CSRF protections.</p> <p>Attackers can exploit this by intercepting the authorization process to link their account with a victim’s account, leading to potential <strong>account takeovers</strong>. This is especially critical in applications where OAuth is used for <strong>authentication purposes</strong>.</p> <p>Real-world examples of this vulnerability have been documented in various <strong>CTF challenges</strong> and <strong>hacking platforms</strong>, highlighting its practical implications. The issue also extends to integrations with third-party services like <strong>Slack</strong>, <strong>Stripe</strong>, and <strong>PayPal</strong>, where attackers can redirect notifications or payments to their accounts.</p> <p>Proper handling and validation of the <strong><code class="language-plaintext highlighter-rouge">state</code> parameter</strong> are crucial for safeguarding against CSRF and securing the OAuth flow.</p> <h3 id="pre-account-takeover-">Pre Account Takeover <a href="#ebe4" id="ebe4"></a> </h3> <ol> <li> <strong>Without Email Verification on Account Creation</strong>: Attackers can preemptively create an account using the victim’s email. If the victim later uses a third-party service for login, the application might inadvertently link this third-party account to the attacker’s pre-created account, leading to unauthorized access.</li> <li> <strong>Exploiting Lax OAuth Email Verification</strong>: Attackers may exploit OAuth services that don’t verify emails by registering with their service and then changing the account email to the victim’s. This method similarly risks unauthorized account access, akin to the first scenario but through a different attack vector.</li> </ol> <h3 id="disclosure-of-secrets-">Disclosure of Secrets <a href="#e177" id="e177"></a> </h3> <p>Identifying and protecting secret OAuth parameters is crucial. While the <strong><code class="language-plaintext highlighter-rouge">client_id</code></strong> can be safely disclosed, revealing the <strong><code class="language-plaintext highlighter-rouge">client_secret</code></strong> poses significant risks. If the <code class="language-plaintext highlighter-rouge">client_secret</code> is compromised, attackers can exploit the identity and trust of the application to <strong>steal user <code class="language-plaintext highlighter-rouge">access_tokens</code></strong> and private information.</p> <p>A common vulnerability arises when applications mistakenly handle the exchange of the authorization <code class="language-plaintext highlighter-rouge">code</code> for an <code class="language-plaintext highlighter-rouge">access_token</code> on the client-side rather than the server-side. This mistake leads to the exposure of the <code class="language-plaintext highlighter-rouge">client_secret</code>, enabling attackers to generate <code class="language-plaintext highlighter-rouge">access_tokens</code> under the guise of the application. Moreover, through social engineering, attackers could escalate privileges by adding additional scopes to the OAuth authorization, further exploiting the application’s trusted status.</p> <h3 id="client-secret-bruteforce">Client Secret Bruteforce</h3> <p>You can try to <strong>bruteforce the client_secret</strong> of a service provider with the identity provider in order to be try to steal accounts.<br> The request to BF may look similar to:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&amp;redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&amp;grant_type=authorization_code&amp;client_id=public_client_id&amp;client_secret=[bruteforce]
</code></pre></div></div> <h3 id="referer-header-leaking-code--state">Referer Header leaking Code + State</h3> <p>Once the client has the <strong>code and state</strong>, if it’s <strong>reflected inside the Referer header</strong> when he browses to a different page, then it’s vulnerable.</p> <h3 id="access-token-stored-in-browser-history">Access Token Stored in Browser History</h3> <p>Go to the <strong>browser history and check if the access token is saved in there</strong>.</p> <h3 id="everlasting-authorization-code">Everlasting Authorization Code</h3> <p>The <strong>authorization code should live just for some time to limit the time window where an attacker can steal and use it</strong>.</p> <h3 id="authorizationrefresh-token-not-bound-to-client">Authorization/Refresh Token not bound to client</h3> <p>If you can get the <strong>authorization code and use it with a different client then you can takeover other accounts</strong>.</p> <h3 id="happy-paths-xss-iframes--post-messages-to-leak-code--state-values">Happy Paths, XSS, Iframes &amp; Post Messages to leak code &amp; state values</h3> <p><a href="https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url" rel="external nofollow noopener" target="_blank"><strong>Check this post</strong></a></p> <h3 id="aws-cognito-">AWS Cognito <a href="#bda5" id="bda5"></a> </h3> <p>In this bug bounty report: <a href="https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/" rel="external nofollow noopener" target="_blank"><strong>https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/</strong></a> you can see that the <strong>token</strong> that <strong>AWS Cognito</strong> gives back to the user might have <strong>enough permissions to overwrite the user data</strong>. Therefore, if you can <strong>change the user email for a different user email</strong>, you might be able to <strong>take over</strong> others accounts.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Read info of the user</span>
aws cognito-idp get-user <span class="nt">--region</span> us-east-1 <span class="nt">--access-token</span> eyJraWQiOiJPVj[...]

<span class="c"># Change email address</span>
aws cognito-idp update-user-attributes <span class="nt">--region</span> us-east-1 <span class="nt">--access-token</span> eyJraWQ[...] <span class="nt">--user-attributes</span> <span class="nv">Name</span><span class="o">=</span>email,Value<span class="o">=</span>imaginary@flickr.com
<span class="o">{</span>
    <span class="s2">"CodeDeliveryDetailsList"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"Destination"</span>: <span class="s2">"i***@f***.com"</span>,
            <span class="s2">"DeliveryMedium"</span>: <span class="s2">"EMAIL"</span>,
            <span class="s2">"AttributeName"</span>: <span class="s2">"email"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div> <p>For more detailed info about how to abuse AWS cognito check:</p> <p>https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum.html</p> <h3 id="abusing-other-apps-tokens-">Abusing other Apps tokens <a href="#bda5" id="bda5"></a> </h3> <p>As <a href="https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts" rel="external nofollow noopener" target="_blank"><strong>mentioned in this writeup</strong></a>, OAuth flows that expect to receive the <strong>token</strong> (and not a code) could be vulnerable if they not check that the token belongs to the app.</p> <p>This is because an <strong>attacker</strong> could create an <strong>application supporting OAuth and login with Facebook</strong> (for example) in his own application. Then, once a victim logins with Facebook in the <strong>attackers application</strong>, the attacker could get the <strong>OAuth token of the user given to his application, and use it to login in the victim OAuth application using the victims user token</strong>.</p> <blockquote> <p>[!CAUTION] Therefore, if the attacker manages to get the user access his own OAuth application, he will be able to take over the victims account in applications that are expecting a token and aren’t checking if the token was granted to their app ID.</p> </blockquote> <h3 id="two-links--cookie-">Two links &amp; cookie <a href="#bda5" id="bda5"></a> </h3> <p>According to <a href="https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f" rel="external nofollow noopener" target="_blank"><strong>this writeup</strong></a>, it was possible to make a victim open a page with a <strong>returnUrl</strong> pointing to the attackers host. This info would be <strong>stored in a cookie (RU)</strong> and in a <strong>later step</strong> the <strong>prompt</strong> will <strong>ask</strong> the <strong>user</strong> if he wants to give access to that attackers host.</p> <p>To bypass this prompt, it was possible to open a tab to initiate the <strong>Oauth flow</strong> that would set this RU cookie using the <strong>returnUrl</strong>, close the tab before the prompt is shown, and open a new tab without that value. Then, the <strong>prompt won’t inform about the attackers host</strong>, but the cookie would be set to it, so the <strong>token will be sent to the attackers host</strong> in the redirection.</p> <h3 id="prompt-interaction-bypass-">Prompt Interaction Bypass <a href="#bda5" id="bda5"></a> </h3> <p>As explained in <a href="https://www.youtube.com/watch?v=n9x7_J_a_7Q" rel="external nofollow noopener" target="_blank"><strong>this video</strong></a>, some OAuth implementations allows to indicate the <strong><code class="language-plaintext highlighter-rouge">prompt</code></strong> GET parameter as None (<strong><code class="language-plaintext highlighter-rouge">&amp;prompt=none</code></strong>) to <strong>prevent users being asked to confirm</strong> the given access in a prompt in the web if they are already logged in the platform.</p> <h3 id="response_mode">response_mode</h3> <p>As <a href="https://www.youtube.com/watch?v=n9x7_J_a_7Q" rel="external nofollow noopener" target="_blank"><strong>explained in this video</strong></a>, it might be possible to indicate the parameter <strong><code class="language-plaintext highlighter-rouge">response_mode</code></strong> to indicate where do you want the code to be provided in the final URL:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">response_mode=query</code> -&gt; The code is provided inside a GET parameter: <code class="language-plaintext highlighter-rouge">?code=2397rf3gu93f</code> </li> <li> <code class="language-plaintext highlighter-rouge">response_mode=fragment</code> -&gt; The code is provided inside the URL fragment parameter <code class="language-plaintext highlighter-rouge">#code=2397rf3gu93f</code> </li> <li> <code class="language-plaintext highlighter-rouge">response_mode=form_post</code> -&gt; The code is provided inside a POST form with an input called <code class="language-plaintext highlighter-rouge">code</code> and the value</li> <li> <code class="language-plaintext highlighter-rouge">response_mode=web_message</code> -&gt; The code is send in a post message: <code class="language-plaintext highlighter-rouge">window.opener.postMessage({"code": "asdasdasd...</code> </li> </ul> <h3 id="oauth-ropc-flow---2-fa-bypass-">OAuth ROPC flow - 2 FA bypass <a href="#b440" id="b440"></a> </h3> <p>According to <a href="https://cybxis.medium.com/a-bypass-on-gitlabs-login-email-verification-via-oauth-ropc-flow-e194242cad96" rel="external nofollow noopener" target="_blank"><strong>this blog post</strong></a>, this is an OAuth flow that allows to login in OAuth via <strong>username</strong> and <strong>password</strong>. If during this simple flow a <strong>token</strong> with access to all the actions the user can perform is returned then it’s possible to bypass 2FA using that token.</p> <h3 id="ato-on-web-page-redirecting-based-on-open-redirect-to-referrer-">ATO on web page redirecting based on open redirect to referrer <a href="#bda5" id="bda5"></a> </h3> <p>This <a href="https://blog.voorivex.team/oauth-non-happy-path-to-ato" rel="external nofollow noopener" target="_blank"><strong>blogpost</strong></a> comments how it was possible to abuse an <strong>open redirect</strong> to the value from the <strong>referrer</strong> to abuse OAuth to ATO. The attack was:</p> <ol> <li>Victim access the attackers web page</li> <li>The victim opens the malicious link and an opener starts the Google OAuth flow with <code class="language-plaintext highlighter-rouge">response_type=id_token,code&amp;prompt=none</code> as additional parameters using as <strong>referrer the attackers website</strong>.</li> <li>In the opener, after the provider authorizes the victim, it sends them back to the value of the <code class="language-plaintext highlighter-rouge">redirect_uri</code> parameter (victim web) with 30X code which still keeps the attackers website in the referer.</li> <li>The victim <strong>website trigger the open redirect based on the referrer</strong> redirecting the victim user to the attackers website, as the <strong><code class="language-plaintext highlighter-rouge">respose_type</code></strong> was <strong><code class="language-plaintext highlighter-rouge">id_token,code</code></strong>, the code will be sent back to the attacker in the <strong>fragment</strong> of the URL allowing him to tacke over the account of the user via Google in the victims site.</li> </ol> <h3 id="ssrfs-parameters-">SSRFs parameters <a href="#bda5" id="bda5"></a> </h3> <p><a href="https://portswigger.net/research/hidden-oauth-attack-vectors" rel="external nofollow noopener" target="_blank"><strong>Check this research</strong></a> <strong>For further details of this technique.</strong></p> <p>Dynamic Client Registration in OAuth serves as a less obvious but critical vector for security vulnerabilities, specifically for <strong>Server-Side Request Forgery (SSRF)</strong> attacks. This endpoint allows OAuth servers to receive details about client applications, including sensitive URLs that could be exploited.</p> <p><strong>Key Points:</strong></p> <ul> <li> <strong>Dynamic Client Registration</strong> is often mapped to <code class="language-plaintext highlighter-rouge">/register</code> and accepts details like <code class="language-plaintext highlighter-rouge">client_name</code>, <code class="language-plaintext highlighter-rouge">client_secret</code>, <code class="language-plaintext highlighter-rouge">redirect_uris</code>, and URLs for logos or JSON Web Key Sets (JWKs) via POST requests.</li> <li>This feature adheres to specifications laid out in <strong>RFC7591</strong> and <strong>OpenID Connect Registration 1.0</strong>, which include parameters potentially vulnerable to SSRF.</li> <li>The registration process can inadvertently expose servers to SSRF in several ways: <ul> <li> <strong><code class="language-plaintext highlighter-rouge">logo_uri</code></strong>: A URL for the client application’s logo that might be fetched by the server, triggering SSRF or leading to XSS if the URL is mishandled.</li> <li> <strong><code class="language-plaintext highlighter-rouge">jwks_uri</code></strong>: A URL to the client’s JWK document, which if maliciously crafted, can cause the server to make outbound requests to an attacker-controlled server.</li> <li> <strong><code class="language-plaintext highlighter-rouge">sector_identifier_uri</code></strong>: References a JSON array of <code class="language-plaintext highlighter-rouge">redirect_uris</code>, which the server might fetch, creating an SSRF opportunity.</li> <li> <strong><code class="language-plaintext highlighter-rouge">request_uris</code></strong>: Lists allowed request URIs for the client, which can be exploited if the server fetches these URIs at the start of the authorization process.</li> </ul> </li> </ul> <p><strong>Exploitation Strategy:</strong></p> <ul> <li>SSRF can be triggered by registering a new client with malicious URLs in parameters like <code class="language-plaintext highlighter-rouge">logo_uri</code>, <code class="language-plaintext highlighter-rouge">jwks_uri</code>, or <code class="language-plaintext highlighter-rouge">sector_identifier_uri</code>.</li> <li>While direct exploitation via <code class="language-plaintext highlighter-rouge">request_uris</code> may be mitigated by whitelist controls, supplying a pre-registered, attacker-controlled <code class="language-plaintext highlighter-rouge">request_uri</code> can facilitate SSRF during the authorization phase.</li> </ul> <h2 id="oauth-providers-race-conditions">OAuth providers Race Conditions</h2> <p>If the platform you are testing is an OAuth provider <a href="race-condition.md"><strong>read this to test for possible Race Conditions</strong></a>.</p> <h2 id="references">References</h2> <ul> <li><a href="https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1" rel="external nofollow noopener" target="_blank"><strong>https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1</strong></a></li> <li><a href="https://portswigger.net/research/hidden-oauth-attack-vectors" rel="external nofollow noopener" target="_blank"><strong>https://portswigger.net/research/hidden-oauth-attack-vectors</strong></a></li> </ul> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>